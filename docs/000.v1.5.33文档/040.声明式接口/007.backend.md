---
id: backend
title: ğŸ® åç«¯æ¡†æ¶
date: 2022-07-01 12:44:20
permalink: /pages/1.5.33/backend/
---

åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡ï¼ŒForeståˆ†ä¸ºå‰ç«¯å’Œåç«¯ä¸¤éƒ¨åˆ†ï¼Œè€Œåç«¯æ˜¯ç”±`okhttp3`å’Œ`httpclient`è¿™æ ·çš„åç«¯HTTPæ¡†æ¶æ„æˆçš„

##  ä¸ºä½•éœ€è¦ä¸åŒçš„åç«¯æ¡†æ¶

å¯èƒ½æœ‰äº›å°ä¼™ä¼´ä¼šæœ‰ç–‘é—®ï¼Œæ—¢ç„¶æŸä¸€ç§HTTPåŒ…ï¼ˆæ¯”å¦‚`okhttp3`ï¼‰å¯ä»¥ä½œä¸ºåç«¯çš„åº•å±‚HTTPæ¡†æ¶ï¼Œå·²æä¾›äº†æ—¥å¸¸æ‰€æœ‰çš„HTTPè¯·æ±‚è®¿é—®åŠŸèƒ½ï¼Œä¸ºä½•è¿˜å†æ”¯æŒå¦ä¸€ç§ä¸åŒçš„HTTPæ¡†æ¶ä½œä¸ºåç«¯å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºæ²¡æœ‰ä¸€ç§æ¡†æ¶éƒ½æ˜¯å®Œç¾çš„ï¼Œéƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ä»¥åŠå·®å¼‚ï¼Œæ¯”å¦‚`okhttp3`æ¥å…¥ç›¸å¯¹ç®€å•ã€åŒæ­¥å¼‚æ­¥å®¹æ˜“åˆ‡æ¢ï¼Œä½†å¾ˆéš¾æ”¯æŒå¸¦è¯·æ±‚ä½“çš„GETè¯·æ±‚è¿™ç§éæ ‡å‡†çš„ç•¸å½¢è¯·æ±‚ï¼ˆä½†å¾€å¾€ä¸šåŠ¡ä¸­éœ€è¦è¿™ç§ç±»å‹è¯·æ±‚ï¼‰;
è€Œ`httpclient(5.0ç‰ˆæœ¬ä»¥ä¸‹)`æ€§èƒ½è¾ƒå¥½ï¼Œæ”¯æŒå„ç§æ ‡å‡†å’Œéæ ‡å‡†è¯·æ±‚ï¼Œä½†æ¥å…¥è¾ƒä¸ºéº»çƒ¦ï¼Œè¿˜éœ€è¦ä¾èµ–å¾ˆå¤šçš„jaråŒ…ï¼Œä¸”ä¸æ”¯æŒ`HTTP/2`åè®®

Foreståœ¨æŸç§ç¨‹åº¦ä¸Šå¯ä»¥è¢«ç†è§£ä¸ºæ˜¯ä¸€ä¸ªå±è”½å±‚ï¼Œå°½å¯èƒ½åœ°å±è”½ä¸åŒåç«¯åº•å±‚HTTPæ¡†æ¶ä¹‹é—´çš„å·®å¼‚ï¼Œæ¯”å¦‚æœ‰ç»Ÿä¸€çš„æ¥å£è°ƒç”¨æ–¹å¼ã€ç»Ÿä¸€çš„é…ç½®ç­‰ç­‰ï¼Œä½†è¿˜æ˜¯æœ‰äº›åº•å±‚çš„ç‰¹æ€§å·®å¼‚æ˜¯Forestæ— èƒ½ä¸ºåŠ›çš„ï¼Œæ¯”å¦‚è®©`okhttp3`çš„GETè¯·æ±‚æºå¸¦Bodyè¿™ä»¶äº‹å°±éš¾ä»¥åšåˆ°

å¯¹äºè¿™æ ·çš„é—®é¢˜ï¼ŒForestç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ç»„åˆä½¿ç”¨ä¸åŒçš„åç«¯æ¡†æ¶ï¼Œæ¢å¥è¯è¯´å°±æ˜¯åœ¨éœ€è¦çš„åœ°æ–¹ä½¿ç”¨ç›¸åº”çš„åç«¯æ¡†æ¶

## å…¨å±€åç«¯æ¡†æ¶

Forestæœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åç«¯ï¼Œå¹¶ä»¥æ­¤ä¸ºHTTPè¯·æ±‚çš„é»˜è®¤åç«¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º`okhttp3`

<code-group>
<code-block title="Yaml" active>

```yaml
# è®¾ç½®å…¨å±€åç«¯æ¡†æ¶
# ç›®å‰ç‰ˆæœ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šokhttp3 å’Œ httpclient
# ä¸å¡«çš„é»˜è®¤è¯·æ±‚ä¸º okhttp3

forest:
    backend: httpclient # è®¾ç½®å…¨å±€åç«¯ä¸º httpclient
```

```yaml
# è®¾ç½®å…¨å±€åç«¯æ¡†æ¶
# ç›®å‰ç‰ˆæœ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šokhttp3 å’Œ httpclient
# ä¸å¡«çš„é»˜è®¤è¯·æ±‚ä¸º okhttp3

forest:
    backend: okhttp3 # è®¾ç½®å…¨å±€åç«¯ä¸º okhttp3
```

</code-block>
<code-block title="Properties">

```properties
# è®¾ç½®å…¨å±€åç«¯æ¡†æ¶
# ç›®å‰ç‰ˆæœ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šokhttp3 å’Œ httpclient
# ä¸å¡«çš„é»˜è®¤è¯·æ±‚ä¸º okhttp3

# è®¾ç½®å…¨å±€åç«¯ä¸º httpclient
forest.backend=httpclient
```

```properties
# è®¾ç½®å…¨å±€åç«¯æ¡†æ¶
# ç›®å‰ç‰ˆæœ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šokhttp3 å’Œ httpclient
# ä¸å¡«çš„é»˜è®¤è¯·æ±‚ä¸º okhttp3

# è®¾ç½®å…¨å±€åç«¯ä¸º okhttp3
forest.backend=okhttp3
```

</code-block>

<code-block title="Spring">

```xml
<!-- backend åç«¯HTTP APIï¼š httpclient -->
<forest:configuration
    ... ...
    backend="httpclient">
... ...
</forest:configuration>
```

```xml
<!-- backend åç«¯HTTP APIï¼š okhttp3 -->
<forest:configuration
    ... ...
    backend="okhttp3">
... ...
</forest:configuration>
```

</code-block>
<code-block title="Java">

```java
// ç›®å‰ç‰ˆæœ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šokhttp3 å’Œ httpclient
// ä¸å¡«çš„é»˜è®¤è¯·æ±‚ä¸º okhttp3

// è·å–å…¨å±€é»˜è®¤é…ç½®å¯¹è±¡
ForestConfiguration configuration = Forest.config();
// è®¾ç½®å…¨å±€åç«¯ä¸º httpclient
configuration.setBackend(new HttpclientBackend());
```

```java
// ç›®å‰ç‰ˆæœ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼šokhttp3 å’Œ httpclient
// ä¸å¡«çš„é»˜è®¤è¯·æ±‚ä¸º okhttp3

// è·å–Forestå…¨å±€é…ç½®å¯¹è±¡
ForestConfiguration configuration = Forest.config();
// è®¾ç½®å…¨å±€åç«¯æ¡†æ¶ä¸º okhttp3
configuration.setBackend(new OkHttp3Backend());
```

</code-block>
</code-group>



å¦‚æœè¦é€šè¿‡<mark>ä»£ç æ–¹å¼</mark>è®¾ç½®åç«¯æ¡†æ¶ï¼Œå»ºè®®å°†åç«¯å¯¹è±¡ä½œä¸ºé™æ€å¸¸é‡å¸¸é©»äºå†…å­˜ï¼Œè€Œä¸æ˜¯ç»å¸¸é‡å¤å®ä¾‹åŒ–åŒæ ·çš„åç«¯å¯¹è±¡

```java
public class MyBackend {
    // httpclient åç«¯å¯¹è±¡
    public final static HttpclientBackend HTTPCLIENT = new HttpclientBackend();
    // okhttp3 åç«¯å¯¹è±¡
    public final static OkHttp3Backend OKHTTP3 = new OkHttp3Backend();
}
```
```java
// è·å–Forestå…¨å±€é…ç½®å¯¹è±¡
ForestConfiguration configuration = Forest.config();
// è®¾ç½®å…¨å±€åç«¯æ¡†æ¶ä¸º httpclient
configuration.setBackend(MyBackend.HTTPCLIENT);
```

```java
// è·å–Forestå…¨å±€é…ç½®å¯¹è±¡
ForestConfiguration configuration = Forest.config();
// è®¾ç½®å…¨å±€åç«¯æ¡†æ¶ä¸º okhttp3
configuration.setBackend(MyBackend.OKHTTP3);
```

## æ¥å£/è¯·æ±‚åç«¯æ¡†æ¶

å…¨å±€åç«¯æ¡†æ¶å¯ä»¥é…ç½®å’Œåˆ‡æ¢ï¼Œç”šè‡³å¯ä»¥è¿›è¡ŒåŠ¨æ€åˆ‡æ¢ï¼Œä½†å¾ˆå¤šæ—¶å€™éœ€è¦åŒæ—¶ä½¿ç”¨ä¸åŒçš„åç«¯æ¡†æ¶ï¼Œæ¯”å¦‚ä¸¤ä¸ªä¸åŒçš„æ¥å£åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„åç«¯

è‡ª`1.5.5`ç‰ˆæœ¬åï¼ŒForestæ”¯æŒäº†æ¥å£/è¯·æ±‚çº§åˆ«çš„åç«¯æ¡†æ¶é…ç½®ï¼Œæ–¹ä¾¿HTTPè¯·æ±‚çµæ´»è®¾ç½®åç«¯

### åç«¯å¿«æ·æ³¨è§£

Forestæä¾›äº† `@HttpClient` æ³¨è§£å’Œ `OkHttp3` æ³¨è§£ï¼Œåˆ†åˆ«ç”¨äºç»‘å®šè¯·æ±‚çš„åç«¯ä¸º `httpclient` å’Œ `okhttp3`

```java{2,7}
// ç»‘å®šè¯·æ±‚çš„åç«¯ä¸º httpclient
@HttpClient
@Post("/data1")
String send1(@Body MyUser user);

// ç»‘å®šè¯·æ±‚çš„åç«¯ä¸º okhttp3
@OkHttp3
@Post("/data2")
String send2(@Body MyUser user);
```
å¦‚æœæ­¤ç±»æ³¨è§£ä¹Ÿç»‘å®šåˆ°**æ¥å£**ä¸Šï¼Œé‚£ä¹ˆè¯¥æ¥å£ä¸‹çš„æ‰€æœ‰æ–¹æ³•çš„è¯·æ±‚é»˜è®¤ä¸ºè¯¥æ¥å£æ³¨è§£æŒ‡å®šçš„åç«¯æ¡†æ¶

```java{2,11}
// è®¾ç½®è¯¥è¯·æ±‚æ¥å£çš„åç«¯æ¡†æ¶é»˜è®¤ä¸º httpclient
@HttpClient
public interface BackendClient2 {

    // æœªè®¾ç½®è¯·æ±‚çš„åç«¯ï¼Œåˆ™é»˜è®¤ä¸ºæ¥å£æŒ‡å®šçš„åç«¯æ¡†æ¶ï¼Œå³ httpclient
    @Post("/data1")
    String send1(@Body MyUser user);

    // ç»‘å®šæŸä¸€æ–¹æ³•è¯·æ±‚çš„åç«¯ä¸º okhttp3
    // ä¼šè¦†ç›–æ‰æ¥å£ä¸Šç»‘å®šçš„åç«¯
    @OkHttp3
    @Post("/data2")
    String send2(@Body MyUser user);
}

```

### @Backend æ³¨è§£

è¿˜æœ‰ä¸€ç§æ›´ä¸ºçµæ´»å’Œé€šç”¨çš„æ³¨è§£ `@Backend`, å¯ä»¥é€šè¿‡ä¼ å…¥çš„å­—ç¬¦ä¸²å‚æ•°æ¥ç¡®å®šå…·ä½“è¦ç»‘å®šçš„åç«¯æ¡†æ¶

```java{2,10}
// è®¾ç½®è¯¥è¯·æ±‚æ¥å£çš„åç«¯æ¡†æ¶é»˜è®¤ä¸º httpclient
@Backend("httpclient")
public interface BackendClient2 {

    // æœªè®¾ç½®è¯·æ±‚çš„åç«¯ï¼Œåˆ™é»˜è®¤ä¸ºæ¥å£æŒ‡å®šçš„åç«¯æ¡†æ¶ï¼Œå³ httpclient
    @Post("/data1")
    String send1(@Body MyUser user);

    // ç»‘å®šè¯·æ±‚çš„åç«¯ä¸º okhttp3
    @Backend("okhttp3")
    @Post("/data2")
    String send2(@Body MyUser user);
}

```

è¯¥æ³¨è§£çš„å‚æ•°ä¹Ÿæ”¯æŒå­—ç¬¦ä¸²æ¨¡æ¿ï¼Œå³å¯ä»¥é€šè¿‡å…¨å±€å˜é‡å’Œå‚æ•°æ¥åŠ¨æ€ä¼ å…¥

```java
@Backend("{0}")
@Post("/data")
String send(String backend, @Body MyUser user);
```
:::tip æç¤º
å¯¹äºå¦‚ä½•åœ¨é spring/springboot é¡¹ç›®ä¸­é€šè¿‡ä»£ç è®¾ç½®åç«¯æ¡†æ¶ï¼Œè¯·å‚è§ã€Š[è¯·æ±‚å¯¹è±¡ - åç«¯æ¡†æ¶](/pages/1.5.33/api_backend/)ã€‹
:::


## è‡ªå®šä¹‰åç«¯ Client å¯¹è±¡

Forest åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šè‡ªåŠ¨ç”Ÿæˆåç«¯ Client å¯¹è±¡å®ä¾‹ï¼Œå¹¶è¿›è¡Œç¼“å­˜ã€‚ä½†å¦‚æœæ‚¨æƒ³è¿›è¡Œæ›´ç»†è‡´çš„æ“ä½œæ—¶ä¹Ÿå¯ä»¥è‡ªè¡Œç”Ÿæˆå’Œé…ç½®åç«¯ Client å¯¹è±¡ã€‚

### OkHttpClient

è‡ªå®šä¹‰ OkHttp3 æ¡†æ¶çš„ OkHttpClient å¯¹è±¡ï¼Œåªéœ€å®ç°`OkHttpClientProvider`æ¥å£

```java
public class MyOkHttpClientProvider implements OkHttpClientProvider {

    @Override
    public OkHttpClient getClient(ForestRequest request, LifeCycleHandler lifeCycleHandler) {
        OkHttpClient okHttpClient = new OkHttpClient.Builder()
                .connectTimeout(700, TimeUnit.SECONDS)
                .readTimeout(700, TimeUnit.SECONDS)
                .writeTimeout(700, TimeUnit.SECONDS)
                .callTimeout(700, TimeUnit.SECONDS)
                .followSslRedirects(false)
                .retryOnConnectionFailure(false)
                .followRedirects(false)
                .build();
        return okHttpClient;
    }
}
```

ç»‘å®šè¯¥è‡ªå®šä¹‰çš„ OkHttpClient å¯¹è±¡æä¾›è€…

```java{2}
@Get("/")
@OkHttp3(client = MyOkHttpClientProvider.class)
ForestResponse<String> sendData();
```

### HttpClient

åŒç†ï¼Œè‡ªå®šä¹‰ Apache Httpclient æ¡†æ¶çš„ HttpClient å¯¹è±¡ï¼Œä¹Ÿåªéœ€å®ç°`HttpClientProvider`æ¥å£

```java
public class MyHttpClientProvider implements HttpClientProvider {

    @Override
    public HttpClient getClient(ForestRequest request, LifeCycleHandler lifeCycleHandler) {
        RequestConfig config = RequestConfig.custom()
                .setConnectTimeout(700 * 1000)
                .setSocketTimeout(700 * 1000)
                .setConnectionRequestTimeout(700 * 1000)
                .setRedirectsEnabled(false)
                .build();
        CloseableHttpClient httpClient = HttpClients.custom()
                .setDefaultRequestConfig(config)
                .build();
        return httpClient;
    }
}
```

ç»‘å®šè¯¥è‡ªå®šä¹‰çš„ HttpClient å¯¹è±¡æä¾›è€…

```java{2}
@Get("/")
@HttpClient(client = MyHttpClientProvider.class)
ForestResponse<String> sendData();
```

## åç«¯ Client ç¼“å­˜

ä¸ºæé«˜ Forest è¯·æ±‚çš„æ‰§è¡Œæ€§èƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªè¯·æ±‚æ‰€å¯¹åº”çš„åç«¯å®¢æˆ·ç«¯å¯¹è±¡éƒ½ä¼šè¢«**ç¼“å­˜**

è¯·æ±‚å‰ï¼Œä¼šå…ˆå»ç¼“å­˜ä¸­å¯»æ‰¾æ‰€éœ€çš„åç«¯ Client å¯¹è±¡å®ä¾‹ï¼Œå¦‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ªå¹¶æ”¾å…¥è¯¥è¯·æ±‚æ‰€å¯¹åº”çš„ç¼“å­˜ä¸­

æ¥å£çš„ç¼“å­˜å¼€å…³è®¾å®šå¦‚ä¸‹:

```java{3}
// å…³é—­åç«¯ Client ç¼“å­˜
@Get("/")
@BackendClient(cache = false)
ForestRequest<String> sendData();
```
