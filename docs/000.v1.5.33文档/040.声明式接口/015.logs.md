---
id: logs
title: ğŸ‚ æ—¥å¿—ç®¡ç†
date: 2022-07-01 12:44:20
permalink: /pages/1.5.33/logs/
---

Foreståœ¨å‘é€è¯·æ±‚æ—¶å’Œæ¥å—å“åº”æ•°æ®æ—¶éƒ½ä¼šè‡ªåŠ¨æ‰“å°å‡ºHTTPè¯·æ±‚ç›¸å…³çš„æ—¥å¿—ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šè¯·æ±‚æ—¥å¿—ã€å“åº”çŠ¶æ€æ—¥å¿—ã€å“åº”å†…å®¹æ—¥å¿—ã€‚

### è¯·æ±‚æ—¥å¿—

è¯·æ±‚æ—¥å¿—ä¼šæ‰“å°å‡ºæ‰€æœ‰è¯·æ±‚å‘é€çš„å†…å®¹ï¼Œå…¶ä¸­åŒ…æ‹¬è¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ä¸‰éƒ¨åˆ†

```
[Forest] Request: 
	POST http://localhost:8080/test HTTP
	Headers: 
		accessToken: abcdefg123456
	Body: username=foo&password=bar
```

è¿™æ®µå†…å®¹å°±æ˜¯è¯·æ±‚æ—¥å¿—ï¼ŒåŒ…å«çš„å‘é€HTTPè¯·æ±‚çš„æ‰€æœ‰å‡ ä¹æ‰€æœ‰ä¿¡æ¯ï¼Œä¹Ÿå¾ˆå®¹æ˜“çœ‹æ‡‚ã€‚å¦‚è‹¥çœ‹ä¸æ‡‚ï¼Œè¿˜è¯·å‚è§ã€Š[HTTPè¯·æ±‚æŠ¥æ–‡](https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html)ã€‹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚


### å“åº”çŠ¶æ€æ—¥å¿—

å“åº”çŠ¶æ€æ—¥å¿—åŒ…å«äº†HTTPè¯·æ±‚å“åº”åæ¥å—åˆ°çš„çŠ¶æ€ç ï¼Œä»¥åŠå“åº”æ—¶é—´

```
[Forest] Response: Status = 200, Time = 11ms
```

Statusä¸ºçŠ¶æ€ç ï¼šæ ‡å‡†çš„HTTPåè®®å®šä¹‰çš„è¯·æ±‚å“åº”çŠ¶æ€ç ï¼Œå¦‚è‹¥ä¸æ¸…æ¥šï¼Œå¯ä»¥å‚è§ã€Š[HTTPçŠ¶æ€ç ](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html)ã€‹

Timeä¸ºè¯·æ±‚å“åº”æ—¶é—´ï¼šä»å®¢æˆ·ç«¯è¯·æ±‚å‘é€åˆ°æ¥å—åˆ°å“åº”æ•°æ®çš„æ€»æ—¶é—´

### å“åº”å†…å®¹æ—¥å¿—

å“åº”å†…å®¹æ—¥å¿—åˆ™ä¼šæ‰“å°å‡ºè¯·æ±‚å‘é€çš„ç›®æ ‡æœåŠ¡å™¨å“åº”åï¼Œè¿”å›ç»™è¯·æ±‚æ¥å—æ–¹çš„å®é™…æ•°æ®å†…å®¹

```
[Forest] Response: Content={"flag":"success","message":"æˆåŠŸ"}
```

`Content=`åé¢çš„å†…å®¹ä¾¿æ˜¯è¯·æ±‚å“åº”æ¥å—åˆ°çš„æ•°æ®

:::tip å‹æƒ…æç¤º

å“åº”å†…å®¹æ—¥å¿—é»˜è®¤æ˜¯å…³é—­çš„

:::

### æ—¥å¿—æ€»å¼€å…³

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åªåœ¨è°ƒè¯•çš„æ—¶å€™æ‰“å°æ—¥å¿—ï¼Œä¸Šäº†ç”Ÿäº§ç¯å¢ƒåä¸ºäº†èŠ‚çœæ€§èƒ½ä¾¿ä¸æ‰“å°äº†ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰å…¬å¸éƒ½ä¸åœ¨ç”Ÿäº§æ‰“å°æ—¥å¿—ï¼Œæ¯•ç«Ÿä¸‡ä¸€å‡ºäº†é—®é¢˜ä¹Ÿæ˜¯è¦æœ‰æ®å¯å¾ªçš„ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¸ªæ —å­( â€¢âŒ„â€¢ )ï¼‰ï¼Œ
ä¾¿éœ€è¦é€šè¿‡é…ç½®çš„æ–¹å¼æ‰“å¼€å’Œå…³é—­HTTPè¯·æ±‚çš„æ—¥å¿—ã€‚

```yaml
forest:
  ## æ—¥å¿—æ€»å¼€å…³ï¼Œæ‰“å¼€/å…³é—­Forestè¯·æ±‚/å“åº”æ—¥å¿—ï¼ˆé»˜è®¤ä¸º trueï¼‰
  log-enabled: true
  ## æ‰“å¼€/å…³é—­Forestè¯·æ±‚æ—¥å¿—ï¼ˆé»˜è®¤ä¸º trueï¼‰
  log-request: true
  ## æ‰“å¼€/å…³é—­Forestå“åº”çŠ¶æ€æ—¥å¿—ï¼ˆé»˜è®¤ä¸º trueï¼‰
  log-response-status: true
  ## æ‰“å¼€/å…³é—­Forestå“åº”å†…å®¹æ—¥å¿—ï¼ˆé»˜è®¤ä¸º falseï¼‰
  log-response-content: true
```


### å•ä¸ªè¯·æ±‚çš„æ—¥å¿—å¼€å…³

æ—¥å¿—çš„æ€»å¼€å…³æ§åˆ¶ç²’åº¦å¤ªè¿‡ç²—æ”¾ï¼Œå¦‚æœæƒ³è¦åªå…³é—­å’Œæ‰“å¼€æŸä¸€ä¸ªè¯·æ±‚çš„æ—¥å¿—æœ‰åŠæ³•å—ï¼Ÿæœ‰çš„~

Forestè‡ª`1.50-BETA1`ç‰ˆæœ¬åæä¾›äº†`@LogEnabled`æ³¨è§£æ¥ä¸“é—¨å¹²è¿™ä¸ªäº‹ã€‚

`@LogEnabled`æ³¨è§£çš„å„å±æ€§å¦‚ä¸‹æ‰€ç¤ºï¼š

| å±æ€§   |  ä½œç”¨ | é»˜è®¤å€¼
| --------------------  | ------------- | ----------|
| value                 | æ˜¯å¦æ‰“å°è¯·æ±‚/å“åº”æ—¥å¿— | `true` |
| logRequest            | æ˜¯å¦æ‰“å°è¯·æ±‚æ—¥å¿— | `true` |
| logResponseStatus     | æ˜¯å¦æ‰“å°å“åº”çŠ¶æ€æ—¥å¿— | `true` |
| logResponseContent    | æ˜¯å¦æ‰“å°å“åº”å†…å®¹æ—¥å¿— | `false` |

å…·ä½“å¦‚ä½•ä½¿ç”¨çœ‹ä¸‹é¢ä¾‹å­ï¼š

```java

/** é»˜è®¤å¼€å…³ï¼šå…è®¸æ‰“å°è¯·æ±‚æ—¥å¿—ã€å“åº”çŠ¶æ€æ—¥å¿—ï¼Œä½†ä¸æ‰“å°å“åº”å†…å®¹æ—¥å¿— */
@Get("http://localhost:8080/send")
@LogEnabled
String send(@Query("msg") String message);

/** åŒä¸Š */
@Get("http://localhost:8080/send")
@LogEnabled(true)
String send(@Query("msg") String message);

/** å…³é—­è¯¥è¯·æ±‚çš„æ‰€æœ‰æ—¥å¿— */
@Get("http://localhost:8080/send")
@LogEnabled(false)
String send(@Query("msg") String message);

/** ä¸æ‰“å°è¯·æ±‚æ—¥å¿— */
@Get("http://localhost:8080/send")
@LogEnabled(logRequest = false)
String send(@Query("msg") String message);

/** ä¸æ‰“å°å“åº”çŠ¶æ€æ—¥å¿— */
@Get("http://localhost:8080/send")
@LogEnabled(logResponseStatus = false)
String send(@Query("msg") String message);

/** æ‰“å°å“åº”å†…å®¹æ—¥å¿— */
@Get("http://localhost:8080/send")
@LogEnabled(logResponseContent = true)
String send(@Query("msg") String message);

```

### è‡ªå®šä¹‰æ—¥å¿—å¤„ç†å™¨

å¦‚æœæœ‰å°ä¼™ä¼´è§‰å¾—Foresté»˜è®¤çš„æ—¥å¿—æ‰“å°æ ¼å¼å¤ªä¸‘ï¼Œé¢†å¯¼éƒ½çœ‹ä¸ä¸‹å»äº†æ€ä¹ˆåŠï¼Ÿ

å¥½æ¶ˆæ¯æ˜¯è‡ª`1.5.0-BETA1`ç‰ˆæœ¬åå¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ‰©å±•æ—¥å¿—å¤„ç†å™¨æ¥æŒ‰è‡ªå·±å–œæ¬¢çš„æ ¼å¼æ‰“å°æ—¥å¿—ã€‚

å®ç°è¿‡ç¨‹ä¹Ÿä¸å¤æ‚ï¼šå®ç°`com.dtflys.forest.logging.ForestLogHandler`æ¥å£ï¼Œæˆ–è€…ç»§æ‰¿`com.dtflys.forest.logging.DefaultLogHandler`ç±»ã€‚

è¿™é‡Œçš„ä¾‹å­ä½¿ç”¨ç»§æ‰¿`DefaultLogHandler`ç±»çš„æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥å°‘äº›å¾ˆå¤šä»£ç 

```java
/**
 * æˆ‘è‡ªå®šä¹‰çš„æ—¥å¿—å¤„ç†å™¨
 */
public class TestLogHandler extends DefaultLogHandler {
  
    /**
     * æ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ‰“å°æ—¥å¿—
     */
    @Override
    public void logContent(String content) {
        super.logContent("[å“ˆå“ˆï¼Œè¿™æ˜¯æˆ‘è‡ªå·±çš„æ—¥å¿—]: " + content);
    }

    /**
     * è¯¥æ–¹æ³•ç”ŸæˆForestè¯·æ±‚çš„æ—¥å¿—å†…å®¹å­—ç¬¦ä¸²
     * @param requestLogMessage è¯·æ±‚æ—¥å¿—å­—ç¬¦ä¸²
     * @return æ—¥å¿—å†…å®¹å­—ç¬¦ä¸²
     */
    @Override
    protected String requestLoggingContent(RequestLogMessage requestLogMessage) {
        StringBuilder builder = new StringBuilder();
        builder.append("è¯·æ±‚: \n\t");
        // æ’å…¥é‡è¯•ä¿¡æ¯
        builder.append(retryContent(requestLogMessage));
        // æ’å…¥ä»£ç†ä¿¡æ¯
        builder.append(proxyContent(requestLogMessage));
        // æ’å…¥è¯·æ±‚ç±»å‹å˜æ›´å†å²ä¿¡æ¯
        builder.append(requestTypeChangeHistory(requestLogMessage));
        // æ’å…¥è¯·æ±‚è¡Œä¿¡æ¯
        builder.append(requestLogMessage.getRequestLine());
        // è·å–å¹¶æ’å…¥æ‰€æœ‰è¯·æ±‚å¤´å†…å®¹
        String headers = requestLoggingHeaders(requestLogMessage);
        if (StringUtils.isNotEmpty(headers)) {
            builder.append("\n\tè¯·æ±‚å¤´: \n");
            builder.append(headers);
        }
        // è·å–å¹¶æ’å…¥æ‰€æœ‰è¯·æ±‚ä½“å†…å®¹
        String body = requestLoggingBody(requestLogMessage);
        if (StringUtils.isNotEmpty(body)) {
            builder.append("\n\tè¯·æ±‚ä½“: \n");
            builder.append(body);
        }
        return builder.toString();
    }

    /**
     * è¯¥æ–¹æ³•ç”ŸæˆForestè¯·æ±‚å“åº”ç»“æœçš„æ—¥å¿—å†…å®¹å­—ç¬¦ä¸²
     * @param responseLogMessage è¯·æ±‚å“åº”æ—¥å¿—å­—ç¬¦ä¸²
     * @return æ—¥å¿—å†…å®¹å­—ç¬¦ä¸²
     */
    @Override
    protected String responseLoggingContent(ResponseLogMessage responseLogMessage) {
        ForestResponse response = responseLogMessage.getResponse();
        if (response != null && response.getException() != null) {
            return "[ç½‘ç»œé”™è¯¯]: " + response.getException().getMessage();
        }
        // è·å–è¯·æ±‚å“åº”çŠ¶æ€ç 
        int status = responseLogMessage.getStatus();
        // è·å–è¯·æ±‚å“åº”æ—¶é—´
        long time = responseLogMessage.getTime();
        if (status >= 0) {
            return "è¯·æ±‚å“åº”: çŠ¶æ€ç : " + status + ", è€—æ—¶: " + time + "ms";
        } else {
            return "[ç½‘ç»œé”™è¯¯]: æœªçŸ¥çš„ç½‘ç»œé”™è¯¯!";
        }
    }

}

```

### é…ç½®å…¨å±€æ—¥å¿—å¤„ç†å™¨

å®šä¹‰å®Œè‡ªå·±çš„æ—¥å¿—å¤„ç†å™¨åå¹¶ä¸ä¼šé©¬ä¸Šå°±ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦åœ¨é…ç½®ä¸­æŒ‡å®šæ‚¨å®šä¹‰çš„æ—¥å¿—å¤„ç†å™¨ç±»ã€‚

æ—¥å¿—å¤„ç†å™¨çš„é…ç½®ä¹Ÿåˆ†ä¸¤ç§ï¼š`å…¨å±€çº§åˆ«`å’Œ`æ¥å£/æ–¹æ³•çº§åˆ«`ã€‚

æˆ‘ä»¬å…ˆçœ‹å…¨å±€æ—¥å¿—å¤„ç†å™¨æ€ä¹ˆé…ç½®ï¼š

```yaml

forest:
  ## å…¨å±€æ—¥å¿—å¤„ç†å™¨ç±»
  log-handler: com.your.site.logging.TestLogHandler

```

### é…ç½®å•ä¸ªè¯·æ±‚çš„æ—¥å¿—å¤„ç†å™¨

å’Œæ—¥å¿—çš„å¼€å…³ä¸€æ ·ï¼Œæˆ‘åªæƒ³å¯¹æŸä¸ªæˆ–æŸå‡ ä¸ªè¯·æ±‚ç”¨è‡ªå®šä¹‰çš„æ—¥å¿—å¤„ç†å™¨ï¼Œä¹Ÿä¸€æ ·æœ‰åŠæ³•ã€‚

Forestæä¾›äº†`@LogHandleræ³¨è§£`æ¥è§£å†³è¿™ä¸ªé—®é¢˜

```java
@Get(url = "http://localhost:8080/send")
@LogHandler(com.your.site.logging.TestLogHandler.class)
String send(@Query("msg") String message);
```
