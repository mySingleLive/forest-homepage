---
id: api_request_async
title: ğŸš å¼‚æ­¥è¯·æ±‚
date: 2022-07-14 12:42:18
permalink: /pages/1.5.29/api_request_async/
---

Forest åœ¨é»˜è®¤æƒ…å†µä¸‹å‘é€çš„è¯·æ±‚éƒ½æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»å‘é€è¯·æ±‚å¼€å§‹ï¼Œè°ƒç”¨å‘é€çš„çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¯·æ±‚çš„å“åº”ç»“æœè¿”å›ä¹‹åæ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œ

ä½†åŒæ · Forest ä¹Ÿæ”¯æŒå¼‚æ­¥è¯·æ±‚ï¼Œå…è®¸æ‚¨å¼‚æ­¥è°ƒç”¨è¯·æ±‚æ¥å£ï¼Œè€Œè°ƒç”¨æ¥å£æ‰€åœ¨çš„çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å¾€ä¸‹åšå…¶å®ƒäº‹æƒ…ï¼Œè¿™æ ·å°±ä¸ä¼šç™½ç™½æµªè´¹æœºå™¨çš„æ€§èƒ½

## åŒæ­¥/å¼‚æ­¥

Forestè¯·æ±‚é»˜è®¤ä¸ºåŒæ­¥çš„ï¼Œå¯ä»¥é€šè¿‡`async()`æ–¹æ³•è®¾ç½®ä¸ºå¼‚æ­¥è¯·æ±‚

> setAsync(boolean async) è®¾ç½®æ˜¯å¦å¼‚æ­¥
>- å‚æ•°`aysnc`: `true` å¼‚æ­¥, `false` åŒæ­¥
>
> sync() è®¾ç½®ä¸ºåŒæ­¥
>
> async() è®¾ç½®ä¸ºå¼‚æ­¥

```java
// æ„å»ºåŒæ­¥ Get è¯·æ±‚
Forest.get("/");
// æ„å»ºå¼‚æ­¥ Get è¯·æ±‚
Forest.get("/").setAsync(true);
// æ„å»ºåŒæ­¥ Get è¯·æ±‚
Forest.get("/").setAsync(false);
// æ„å»ºå¼‚æ­¥ Get è¯·æ±‚
Forest.get("/").async();
// æ„å»ºåŒæ­¥ Get è¯·æ±‚
Forest.get("/").sync();
```

## å¼‚æ­¥å’Œå›è°ƒå‡½æ•°

åœ¨å‘é€å¼‚æ­¥è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œæ¥å£è°ƒç”¨çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šç­‰å¾…è¯·æ±‚çš„å“åº”ç»“æœï¼Œé‚£ä¹ˆå¦‚ä½•å»æ¥å—å¼‚æ­¥è¿”å›çš„æ•°æ®å‘¢ï¼Ÿ

ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯ä½¿ç”¨å›è°ƒå‡½æ•°

```java
Forest.get("/foo")                          // åˆ›å»º GET è¯·æ±‚
        .async()                            // è®¾ç½®ä¸ºå¼‚æ­¥
        .onSuccess(((data, req, res) -> {   // è®¾ç½® OnSuccess å›è°ƒå‡½æ•° (åœ¨è¯·æ±‚æˆåŠŸè¿”å›æ—¶è°ƒç”¨)
        // data ä¸ºå“åº”æˆåŠŸåè¿”å›çš„ååºåˆ—åŒ–è¿‡çš„æ•°æ®
        // req ä¸ºForestè¯·æ±‚å¯¹è±¡ï¼Œå³ ForestRequest ç±»å®ä¾‹
        // res ä¸ºForestå“åº”å¯¹è±¡ï¼Œå³ ForestResponse ç±»å®ä¾‹
        }))
        .onError(((ex, req, res) -> {       // è®¾ç½® OnError å›è°ƒå‡½æ•° (åœ¨è¯·æ±‚å¤±è´¥æ—¶è°ƒç”¨)
        // ex ä¸ºè¯·æ±‚è¿‡ç¨‹å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡
        // req ä¸ºForestè¯·æ±‚å¯¹è±¡ï¼Œå³ ForestRequest ç±»å®ä¾‹
        // res ä¸ºForestå“åº”å¯¹è±¡ï¼Œå³ ForestResponse ç±»å®ä¾‹
        }))
        .execute();                         // å‘é€è¯·æ±‚
```

## Async/Await é£æ ¼

è‡ª Ajax æµè¡Œå¼€å§‹ï¼Œå›è°ƒå‡½æ•°çš„å¼‚æ­¥å¤„ç†æ–¹å¼å°±å·²ç»æ·±å…¥äººå¿ƒï¼Œè¿™ç§æ–¹æ³•è™½å¥½ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘é—®é¢˜

æ¯”å¦‚å›è°ƒåœ°ç‹±ï¼šå¾ˆå®¹æ˜“å†™å‡ºåœ¨Aè¯·æ±‚çš„å›è°ƒå‡½æ•°ä¸­è°ƒç”¨Bè¯·æ±‚ï¼Œç„¶ååœ¨Bè¯·æ±‚çš„å›è°ƒå‡½æ•°ä¸­è°ƒç”¨Cè¯·æ±‚ï¼Œè¿™æ ·çš„å¥—å¨ƒä»£ç 

å¦ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ‰§è¡Œå›è°ƒå‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å’Œè°ƒç”¨æ¥å£çš„çº¿ç¨‹å¹¶éåŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™å°±ä¼šå¼•å…¥å¹¶å‘å’Œé”çš„é—®é¢˜ï¼Œå¤„ç†çš„æ—¶å€™éœ€è¦è°¨æ…å¯¹å¾…

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒForest å¼•å…¥äº†ç¬¬äºŒç§æ–¹æ³• 

(ä» `1.5.27`ç‰ˆæœ¬åå¼€å§‹æ”¯æŒ`ForestFuture`)

```java
String result = Forest.get("/foo") // åˆ›å»º GET è¯·æ±‚
        .async()                   // è®¾ç½®ä¸ºå¼‚æ­¥
        .executeAsFuture()         // å‘é€è¯·æ±‚ï¼Œå¹¶è¿”å› ForestFuture å¯¹è±¡
        .await()                   // é˜»å¡çº¿ç¨‹å¹¶ç­‰å¾…è¯·æ±‚å“åº”ï¼ŒæˆåŠŸå“åº”åä¼šè¿”å› ForestResponse å¯¹è±¡
        .get(String.class);        // è°ƒç”¨ ForestResponse çš„ get æ–¹æ³•è¿›è¡Œè½¬æ¢æ•°æ®å¹¶è¿”å›ç»“æœ
```

:::tip å‹æƒ…æç¤º
è¿™é‡Œçš„`get(String.clss)`æ–¹æ³•è°ƒç”¨çš„æ˜¯ ForestResponse å¯¹è±¡çš„ `get(Class<T>)` æ¥å£, æ˜¯ä¸€ç§åéªŒçš„æ•°æ®è½¬æ¢

è¯¥æ¥å£çš„å…·ä½“ä½¿ç”¨æ–¹å¼è¯·å‚è§ã€Š[åéªŒç±»å‹](/pages/1.5.29/api_response_read/#åéªŒç±»å‹)ã€‹
:::


è¿™ç§æ–¹å¼ç›¸æ¯”å›è°ƒå‡½æ•°æ–¹å¼ï¼Œæ›´ä¸ºç›´è§‚ï¼Œä¹Ÿæ›´ç±»ä¼¼åŒæ­¥æ–¹å¼

åŒæ—¶å‘é€å’Œæ¥å—å¤šä¸ªå¼‚æ­¥è¯·æ±‚æ—¶ï¼Œæ›´èƒ½ä½“ç°å®ƒçš„å¥½å¤„

```java
ForestFuture f1 = Forest.get("/foo") // åˆ›å»ºç¬¬ä¸€ä¸ª GET è¯·æ±‚
        .async()                     // è®¾ç½®ä¸ºå¼‚æ­¥
        .addQuery("id", 0)           // è®¾ç½® Query å‚æ•°
        .executeAsFuture();          // å‘é€è¯·æ±‚å¹¶è¿”å› ForestFuture å¯¹è±¡

ForestFuture f2 = Forest.get("/bar") // åˆ›å»ºç¬¬äºŒä¸ª GET è¯·æ±‚
        .async()                     // è®¾ç½®ä¸ºå¼‚æ­¥
        .addQuery("id", 1)           // è®¾ç½® Query å‚æ•°
        .executeAsFuture();          // å‘é€è¯·æ±‚å¹¶è¿”å› ForestFuture å¯¹è±¡

// åœ¨è¿™é‡Œå¹¶ä¸é˜»å¡çº¿ç¨‹ï¼Œå¯ä»¥åšäº›å…¶å®ƒäº‹æƒ…
doSomething();        

// Forest.await æ–¹æ³•ä¼šé˜»å¡çº¿ç¨‹å¹¶åŒæ—¶ç­‰å¾…å¤šä¸ªè¯·æ±‚
// è¿™é‡ŒåŒæ—¶ç­‰å¾… f1 å’Œ f2 è¿™ä¸¤ä¸ªè¯·æ±‚
// åªæœ‰å½“è¿™ä¸¤ä¸ªè¯·æ±‚éƒ½å®Œæˆæ—¶ï¼Œä¼šè¿”å› ForestResponse å¯¹è±¡åˆ—è¡¨
// å¹¶ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
Forest.await(f1, f2).forEach(res -> {          // éå†æ¯ä¸ª ForestResponse å¯¹è±¡
        String result = res.get(String.class); // ä» ForestResponse ä¸­å–å‡ºæ•°æ®
});
```

æ‰¹é‡å‘é€å’Œç­‰å¾…å¤šä¸ªå¼‚æ­¥è¯·æ±‚

```java
// new ä¸€ä¸ª ForestFuture å¯¹è±¡åˆ—è¡¨
List<ForestFuture> futures = new LinkedList<>();
for (int i = 0; i < 100; i++) {     // å¾ªç¯100æ¬¡
    futures.add(Forest.get("/data") // åˆ›å»ºè¯·æ±‚ï¼Œå¹¶æ·»åŠ åˆ° futures åˆ—è¡¨ä¸­
        .async()                    // è®¾ç½®ä¸ºå¼‚æ­¥
        .addQuery("id", i)          // è®¾ç½® Query å‚æ•°
        .executeAsFuture());        // å‘é€è¯·æ±‚ï¼Œè¿”å› ForestFuture å¯¹è±¡
}

Forest.await(futures).forEach(res -> {     // ç­‰å¾…è¿™100ä¸ªè¯·æ±‚ï¼Œç„¶åè¿›è¡Œéå†
    String result = res.get(String.class); // ä» ForestResponse ä¸­å–å‡ºæ•°æ®
});
```

æ›´ç®€åŒ–çš„æ–¹å¼

```java
// new ä¸€ä¸ª ForestFuture å¯¹è±¡åˆ—è¡¨
List<ForestFuture> futures = new LinkedList<>();
for (int i = 0; i < 100; i++) {     // å¾ªç¯100æ¬¡
    futures.add(Forest.get("/data") // åˆ›å»ºè¯·æ±‚ï¼Œå¹¶æ·»åŠ åˆ° futures åˆ—è¡¨ä¸­
        .async()                    // è®¾ç½®ä¸ºå¼‚æ­¥
        .addQuery("id", i)          // è®¾ç½® Query å‚æ•°
        .executeAsFuture());        // å‘é€è¯·æ±‚ï¼Œè¿”å› ForestFuture å¯¹è±¡
}

Forest.await(futures, res -> {             // ç­‰å¾…è¿™100ä¸ªè¯·æ±‚ï¼Œç„¶åè¿›è¡Œéå†
    String result = res.get(String.class); // ä» ForestResponse ä¸­å–å‡ºæ•°æ®
});
```

## Kotlin åç¨‹

`1.5.27`ç‰ˆæœ¬å¼€å§‹ Forest æ”¯æŒ Kotlin çš„åç¨‹ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹å¹¶ä¸å¼€å¯ï¼Œå¼€å¯æ–¹å¼è¯·å‚è§ã€Š[å¼€å¯ Kotlin åç¨‹](/pages/1.5.29/async/#å¼€å¯-kotlin-åç¨‹)ã€‹

é™¤äº†è¿™ç§å…¨å±€é…ç½®å¤–ï¼ŒForest ä¹Ÿå…è®¸é€šè¿‡ç¼–ç¨‹å¼æ¥å£è®¾ç½®æŸä¸ªå…·ä½“è¯·æ±‚çš„å¼‚æ­¥æ¨¡å¼

```java
Forest.get("/foo")
        .async()
        // è®¾ç½®ä¸º Kotlin åç¨‹
        .asyncMode(ForestAsyncMode.KOTLIN_COROUTINE);
```

ä¹Ÿå¯ä»¥åˆ‡æ¢å›é»˜è®¤çš„çº¿ç¨‹æ± æ¨¡å¼

```java
Forest.get("/foo")
        .async()
        // è®¾ç½®ä¸º Kotlin åç¨‹
        .asyncMode(ForestAsyncMode.PLATFORM);
```
