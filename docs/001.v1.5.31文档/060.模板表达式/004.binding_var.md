---
id: binding_var
title: ğŸ¥ƒ åŠ¨æ€å˜é‡ç»‘å®š
date: 2022-07-01 12:44:20
permalink: /pages/1.5.31/binding_var/
---

åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ`å˜é‡å¼•ç”¨ + é…ç½®æ–‡ä»¶`çš„æ–¹å¼éƒ½å¯ä»¥æ»¡è¶³è¦æ±‚ï¼Œæ¯”å¦‚ï¼šä¸åŒç¯å¢ƒä¸‹é…ç½®ä¸åŒçš„å˜é‡ã€‚ä½†å¦‚æœæˆ‘æƒ³åœ¨æ¯æ¬¡å¼•ç”¨å˜é‡çš„æ—¶å€™ï¼Œéƒ½æ ¹æ®æŸç§æ¡ä»¶åŠ¨æ€è·å–å˜é‡å€¼å°±åŠä¸åˆ°äº†

å› æ­¤ï¼ŒForest åœ¨ `1.5.3` ç‰ˆæœ¬å¼€å§‹ï¼Œæä¾›äº†ä¸€ç§åŠ¨æ€ç»‘å®šå˜é‡åçš„æŠ€æœ¯

## é™æ€å˜é‡ç»‘å®š

åœ¨äº†è§£ä»€ä¹ˆæ˜¯ `åŠ¨æ€å˜é‡ç»‘å®š` ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ `é™æ€å˜é‡ç»‘å®š`

`ForestConfiguration`å¯¹è±¡æä¾›äº†`setVariableValue`æ–¹æ³•å¯ä»¥åŠ¨æ€è®¾ç½®é™æ€ç»‘å®šçš„å…¨å±€å˜é‡å€¼

ä½†è¯¥æ–¹æ³•è®¾ç½®çš„å€¼ä¸ºé™æ€çš„å€¼ï¼Œå³è®¾ç½®å®Œä¹‹åè¯¥å˜é‡å°±ä¸ä¼šè¯¥æ”¹å˜äº†ï¼Œæ‰€æœ‰å†æ¬¡è°ƒç”¨ `setVariableValue` æ–¹æ³•è¦†ç›–åŸæ¥çš„å˜é‡å€¼ï¼Œæ‰€ä»¥ç§°ä¸ºå˜é‡çš„ `é™æ€ç»‘å®š`ã€‚

> setVariableValue(String name, Object value) è®¾ç½®å…¨å±€å˜é‡æ‰€å¯¹åº”çš„å€¼
>- å‚æ•°`name`: å˜é‡å
>- å‚æ•°`name`: å˜é‡å€¼

```java
// è·å– Forest å…¨å±€é…ç½®å¯¹è±¡
ForestConfiguration configuration = Forest.config();
// è®¾ç½®å…¨å±€å˜é‡: name -> Peter
configuration.setVariableValue("name", "Peter");
// è®¾ç½®å…¨å±€å˜é‡: baseUrl -> http://abc.com
configuration.setVariableValue("baseUrl", "http://abc.com");
```
æ­¤æ—¶å°±èƒ½å¼•ç”¨åˆ°åˆšæ‰è®¾ç½®çš„å…¨å±€å˜é‡åäº†

```java
@Get("${baseUrl}/data?n={name}")
String getData();

// è°ƒç”¨è¯¥æ–¹æ³•æ‰€äº§ç”Ÿçš„URLä¸º
// http://abc.com/data?n=Peter
```

## åŠ¨æ€å˜é‡ç»‘å®š

`åŠ¨æ€å˜é‡ç»‘å®š`çš„æ¦‚å¿µæ˜¯ç›¸å¯¹`é™æ€å˜é‡ç»‘å®š`è€Œæ¥çš„ï¼Œé™æ€ç»‘å®šçš„å˜é‡æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œå³ä¸€æ—¦è®¾ç½®å®Œä¹‹åï¼Œå°±ä¸ä¼šå†åšæ”¹å˜ï¼Œæ¯æ¬¡å¼•ç”¨åˆ°åŒä¸€ä¸ªå˜é‡åçš„å€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œé™¤éå°†å˜é‡åé‡æ–°è®¾å€¼ï¼Œè¦†ç›–æ‰åŸæ¥çš„å€¼ã€‚

è€ŒåŠ¨æ€ç»‘å®šçš„å˜é‡å°¤å…¶è¯´æ˜¯å˜é‡ï¼Œå…¶å®æ›´æ¥è¿‘äºå‡½æ•°æˆ–è€…æ–¹æ³•ï¼Œå³æ¯æ¬¡å¼•ç”¨ä¸€ä¸ªå˜é‡åçš„æ—¶å€™éƒ½ä¼šé‡æ–°è®¡ç®—å…¶å˜é‡å€¼ï¼Œç›¸å½“äºè°ƒç”¨ä¸€æ¬¡æ–¹æ³•ï¼Œè€Œå®ƒçš„è¿”å›å€¼å³ä¸ºå˜é‡åæ‰€å¯¹åº”çš„å€¼ã€‚

ä¸Šé¢ä»‹ç»è¿‡çš„`ForestConfiguration`å¯¹è±¡çš„`setVariableValue`æ–¹æ³•çš„å…„å¼Ÿæ–¹æ³•ï¼ˆé‡è½½æ–¹æ³•ï¼‰å¯ä»¥åŠ¨æ€è®¾ç½®åŠ¨æ€ç»‘å®šçš„å…¨å±€å˜é‡å€¼

> setVariableValue(String name, ForestVariableValue value)
>- å‚æ•°`name`: å˜é‡å
>- å‚æ•°`value`: å˜é‡å€¼ï¼Œ`ForestVariableValue`æ¥å£çš„å®ç°ç±»

æ¬¸ï¼Œæˆ‘ä»¬å‘ç°ï¼Œè¿™é‡Œçš„`value`æ˜¯ä¸€ä¸ªæ¥å£ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªæ¥å£æœ¬è´¨ä¸Šå¯ä»¥çœ‹æˆä¸€ä¸ªLambda

```java
// è·å– Forest å…¨å±€é…ç½®å¯¹è±¡
ForestConfiguration configuration = Forest.config();
// å®šä¹‰ä¸€ä¸ªåŸå­æ•´æ•°å¯¹è±¡
AtomicInteger count = new AtomicInteger(0);
// è®¾ç½®å…¨å±€åŠ¨æ€å˜é‡: num -> ä»0å¼€å§‹è®°ï¼Œæ¯æ¬¡å¼•ç”¨åŠ ä¸€çš„å€¼
configuration.setVariableValue("num", (method) -> count.getAndIncrement());
```

æ­¤æ—¶å°±èƒ½å¼•ç”¨åˆ°åˆšæ‰è®¾ç½®çš„å…¨å±€åŠ¨æ€å˜é‡åäº†

```java
@Get("/data?num={num}")
String getData();
```

ç„¶åï¼Œå¤šæ¬¡è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ‰€äº§ç”Ÿçš„ç»“æœéƒ½æ˜¯ä¸åŒçš„ (æ¯æ¬¡éƒ½ç´¯åŠ ä¸€)

```java
myClient.getData(); // ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ŒURL: http://localhost/data?num=0
myClient.getData(); // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ŒURL: http://localhost/data?num=1
myClient.getData(); // ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼ŒURL: http://localhost/data?num=2
```

`ForestVariableValue`æ¥å£çš„ Lambda å¸¦æœ‰ä¸€ä¸ªå‚æ•° `method`, å®ƒæ˜¯ `ForestMethod` ç±»å‹çš„å¯¹è±¡ï¼Œå³ Forest æ¥å£æ–¹æ³•å¯¹è±¡

```java
ForestConfiguration configuration = Forest.config();
// è®¾ç½®å…¨å±€åŠ¨æ€å˜é‡: baseUrl -> æ ¹æ®æ¡ä»¶äº§ç”Ÿä¸åŒçš„IPåœ°å€
configuration.setVariableValue("num", (method) -> {
    // method: Forest æ¥å£æ–¹æ³•å¯¹è±¡ï¼Œå³å¯¹è¯·æ±‚æ‰€å¯¹åº”çš„æ–¹æ³•çš„å°è£…å¯¹è±¡
    // method.getMethodName() è·å¾—è¯·æ±‚æ‰€å¯¹åº”çš„æ–¹æ³•çš„æ–¹æ³•å
    String methodName = method.getMethodName();
    if (methodName.equals("getData")) {
        // è‹¥è°ƒç”¨çš„æ˜¯ getData æ–¹æ³•ï¼Œåˆ™è¿”å› 192.168.0.2
        return "192.168.0.2";
    }
    // é»˜è®¤è¿”å› 192.168.0.1
    return "192.168.0.1";
});
```

å¼•ç”¨è¯¥ baseUrl å˜é‡

```java
@Get("{baseUrl}/data")
String getData();

@Get("{baseUrl}/user")
String getUser();
```

è°ƒç”¨ä¸åŒæ–¹æ³•äº§ç”Ÿçš„ç»“æœ

```java
myClient.getData(); // è°ƒç”¨getDataï¼ŒURL: http://192.168.0.2/data
myClient.getUser(); // è°ƒç”¨getUserï¼ŒURL: http://192.168.0.1/user
```



## @BindingVaræ³¨è§£

è¿˜æœ‰ä¸€ç§æ›´æ–¹ä¾¿çš„å£°åå¼åŠ¨æ€ç»‘å®šå˜é‡çš„åŠæ³•ï¼Œå°±æ˜¯åœ¨ Spring ç¯å¢ƒä¸‹åˆ©ç”¨ `@BindingVar` æ³¨è§£ä¿®é¥°æŸä¸ªåœ¨ Spring ä¸Šä¸‹æ–‡çš„ Bean çš„æ–¹æ³•

```java
@Service("myService")
public class MyService {
    // å®šä¹‰ä¸€ä¸ªåŸå­æ•´æ•°å¯¹è±¡
    private AtomicInteger count = new AtomicInteger(0); 

    /**
     * ä½¿ç”¨ @BindingVar æ³¨è§£
     * å°†å˜é‡å num å’Œä¸€æ®µæ–¹æ³•ä»£ç ç»‘å®š
     * æ–¹æ³•çš„å‚æ•°å¯ä»¥å¿½ç•¥ä¸å®šä¹‰
     * æ¯æ¬¡å¼•ç”¨ num å˜é‡ï¼Œéƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•é‡ç®—å‡ºè¯¥å€¼
     */
    @BindingVar("num")
    public int getNum() {
        // è¿”å›åŸå­æ•´æ•°çš„å€¼ï¼Œæ¯æ¬¡è°ƒç”¨åŠ ä¸€
        return count.getAndIncrement();
    }
    
    /**
     * ä½¿ç”¨ @BindingVar æ³¨è§£
     * å°†å˜é‡å baseUrl å’Œä¸€æ®µæ–¹æ³•ä»£ç ç»‘å®š
     * è¯¥æ–¹æ³•å¯ä»¥æœ‰ä¸€ä¸ª ForestMethod ç±»å‹çš„å‚æ•°
     */
    @BindingVar("baseUrl")
    public String getBaseUrl(ForestMethod method) {
        // method: Forest æ¥å£æ–¹æ³•å¯¹è±¡ï¼Œå³å¯¹è¯·æ±‚æ‰€å¯¹åº”çš„æ–¹æ³•çš„å°è£…å¯¹è±¡
        // method.getMethodName() è·å¾—è¯·æ±‚æ‰€å¯¹åº”çš„æ–¹æ³•çš„æ–¹æ³•å
        String methodName = method.getMethodName();
        if (methodName.equals("getData")) {
            // è‹¥è°ƒç”¨çš„æ˜¯ getData æ–¹æ³•ï¼Œåˆ™è¿”å› 192.168.0.2
            return "192.168.0.2";
        }
        // é»˜è®¤è¿”å› 192.168.0.1
        return "192.168.0.1";
    }

}
```
æ­¤æ—¶å°±èƒ½å¼•ç”¨åˆ°åˆšæ‰è®¾ç½®çš„å…¨å±€åŠ¨æ€å˜é‡åäº†

```java
@Get("{baseUrl}/data?num={num}")
String getData();

@Get("{baseUrl}/user?num={num}")
String getUser();
```

ç„¶åï¼Œå¤šæ¬¡è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ‰€äº§ç”Ÿçš„ç»“æœéƒ½æ˜¯ä¸åŒçš„ (æ¯æ¬¡éƒ½ç´¯åŠ ä¸€)

```java
myClient.getData(); // ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ŒURL: http://192.168.0.2/data?num=0
myClient.getData(); // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ŒURL: http://192.168.0.2/data?num=1
myClient.getData(); // ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼ŒURL: http://192.168.0.2/data?num=2

myClient.getUser(); // è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼ŒURL: http://192.168.0.1/data?num=3
```
