---
id: interceptor
title: ğŸ¥ª æ‹¦æˆªå™¨
date: 2022-07-01 12:44:20
permalink: /pages/1.5.32/interceptor/
---

ç”¨è¿‡Spring MVCçš„æœ‹å‹ä¸€å®šå¯¹Springçš„æ‹¦æˆªå™¨å¹¶ä¸é™Œç”Ÿï¼ŒForestä¹ŸåŒæ ·æ”¯æŒé’ˆå¯¹Forestè¯·æ±‚çš„æ‹¦æˆªå™¨ã€‚

å¦‚æœæ‚¨æƒ³åœ¨å¾ˆå¤šä¸ªè¯·æ±‚å‘é€ä¹‹å‰æˆ–ä¹‹ååšä¸€äº›äº‹æƒ…ï¼ˆå¦‚æ‰“å°æ—¥å¿—ã€è®¡æ•°ç­‰ç­‰ï¼‰ï¼Œæ‹¦æˆªå™¨å°±æ˜¯æ‚¨çš„å¥½å¸®æ‰‹ã€‚

### æ„å»ºæ‹¦æˆªå™¨

å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨éœ€è¦å®ç°`com.dtflys.forest.interceptor.Interceptor`æ¥å£

````java
public class SimpleInterceptor<T> implements Interceptor<T> {

    private final static Logger log = LoggerFactory.getLogger(SimpleInterceptor.class);

    /**
     * è¯¥æ–¹æ³•åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå¹¶åœ¨beforeExecuteå‰è¢«è°ƒç”¨ 
     * @Param request Forestè¯·æ±‚å¯¹è±¡
     * @Param args æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æ•°ç»„ 
     */
    @Override
    public void onInvokeMethod(ForestRequest req, ForestMethod method, Object[] args) {
        log.info("on invoke method");
        // req ä¸ºForestè¯·æ±‚å¯¹è±¡ï¼Œå³ ForestRequest ç±»å®ä¾‹
        // method ä¸ºForestæ–¹æ³•å¯¹è±¡ï¼Œå³ ForestMethod ç±»å®ä¾‹
        // addAttributeä½œç”¨æ˜¯æ·»åŠ å’ŒForestè¯·æ±‚å¯¹è±¡ä»¥åŠè¯¥æ‹¦æˆªå™¨ç»‘å®šçš„å±æ€§
        addAttribute(req, "A", "value1");
        addAttribute(req, "B", "value2");
    }

    /**
     * åœ¨è¯·æ±‚ä½“æ•°æ®åºåˆ—åŒ–åï¼Œå‘é€è¯·æ±‚æ•°æ®å‰è°ƒç”¨è¯¥æ–¹æ³•
     * é»˜è®¤ä¸ºä»€ä¹ˆéƒ½ä¸åš
     * æ³¨: multlipart/dataç±»å‹çš„æ–‡ä»¶ä¸Šä¼ æ ¼å¼çš„ Body æ•°æ®ä¸ä¼šè°ƒç”¨è¯¥å›è°ƒå‡½æ•°
     *
     * @param request Forestè¯·æ±‚å¯¹è±¡
     * @param encoder Forestè½¬æ¢å™¨
     * @param encodedData åºåˆ—åŒ–åçš„è¯·æ±‚ä½“æ•°æ®
     */
    @Override
    public byte[] onBodyEncode(ForestRequest request, ForestEncoder encoder, byte[] encodedData) {
        // request: Forestè¯·æ±‚å¯¹è±¡
        // encoder: æ­¤æ¬¡è½¬æ¢è¯·æ±‚æ•°æ®çš„åºåˆ—åŒ–å™¨
        // encodedData: åºåˆ—åŒ–åçš„è¯·æ±‚ä½“å­—èŠ‚æ•°ç»„
        // è¿”å›çš„å­—èŠ‚æ•°ç»„å°†æ›¿æ¢åŸæœ‰çš„åºåˆ—åŒ–ç»“æœ
        // é»˜è®¤ä¸åšä»»ä½•å¤„ç†ï¼Œç›´æ¥è¿”å›å‚æ•° encodedData
        return encodedData;
    }


    /**
     * è¯¥æ–¹æ³•åœ¨è¯·æ±‚å‘é€ä¹‹å‰è¢«è°ƒç”¨, è‹¥è¿”å›falseåˆ™ä¸ä¼šç»§ç»­å‘é€è¯·æ±‚
     * @Param request Forestè¯·æ±‚å¯¹è±¡
     */
    @Override
    public boolean beforeExecute(ForestRequest req) {
        log.info("invoke Simple beforeExecute");
        
        // è·å–å…¨å±€å˜é‡æˆ–å‚æ•°ä¸­ @Var("å˜é‡å") ä¿®é¥°çš„å˜é‡
        Object var1 = req.variableValue("å˜é‡å");
        // è·å– Query å˜é‡
        String query1 = req.getQuery("Queryå˜é‡å");
        
         // æ‰§è¡Œåœ¨å‘é€è¯·æ±‚ä¹‹å‰å¤„ç†çš„ä»£ç 
        req.addHeader("accessToken", "11111111");  // æ·»åŠ Header
        req.addQuery("username", "foo");  // æ·»åŠ URLçš„Queryå‚æ•°
        return true;  // ç»§ç»­æ‰§è¡Œè¯·æ±‚è¿”å›true
    }

    /**
     * è¯¥æ–¹æ³•åœ¨è¯·æ±‚æˆåŠŸå“åº”æ—¶è¢«è°ƒç”¨
     */
    @Override
    public void onSuccess(T data, ForestRequest req, ForestResponse res) {
        log.info("invoke Simple onSuccess");
        // æ‰§è¡ŒæˆåŠŸæ¥æ”¶å“åº”åå¤„ç†çš„ä»£ç 
        int status = res.getStatusCode(); // è·å–è¯·æ±‚å“åº”çŠ¶æ€ç 
        String content = res.getContent(); // è·å–è¯·æ±‚çš„å“åº”å†…å®¹
        String result = (String)data;  // dataå‚æ•°æ˜¯æ–¹æ³•è¿”å›ç±»å‹å¯¹åº”çš„è¿”å›æ•°æ®ç»“æœ,æ³¨æ„éœ€è¦è§†æƒ…å†µä¿®æ”¹å¯¹åº”çš„ç±»å‹å¦åˆ™æœ‰å¯èƒ½å‡ºç°ç±»è½¬å‹å¼‚å¸¸
        result = res.getResult(); // getResult()ä¹Ÿå¯ä»¥è·å–è¿”å›çš„æ•°æ®ç»“æœ
        response.setResult("ä¿®æ”¹åçš„ç»“æœ: " + result);  // å¯ä»¥ä¿®æ”¹è¯·æ±‚å“åº”çš„è¿”å›æ•°æ®ç»“æœ
        
        // ä½¿ç”¨getAttributeAsStringå–å‡ºå±æ€§ï¼Œè¿™é‡Œåªèƒ½å–åˆ°ä¸è¯¥Forestè¯·æ±‚å¯¹è±¡ï¼Œä»¥åŠè¯¥æ‹¦æˆªå™¨ç»‘å®šçš„å±æ€§
        String attrValue1 = getAttributeAsString(req, "A1");

    }

    /**
     * è¯¥æ–¹æ³•åœ¨è¯·æ±‚å‘é€å¤±è´¥æ—¶è¢«è°ƒç”¨
     */
    @Override
    public void onError(ForestRuntimeException ex, ForestRequest req, ForestResponse res) {
        log.info("invoke Simple onError");
        // æ‰§è¡Œå‘é€è¯·æ±‚å¤±è´¥åå¤„ç†çš„ä»£ç 
        int status = res.getStatusCode(); // è·å–è¯·æ±‚å“åº”çŠ¶æ€ç 
        String content = res.getContent(); // è·å–è¯·æ±‚çš„å“åº”å†…å®¹
        String result = res.getResult(); // è·å–æ–¹æ³•è¿”å›ç±»å‹å¯¹åº”çš„è¿”å›æ•°æ®ç»“æœ
    }

    /**
     * è¯¥æ–¹æ³•åœ¨è¯·æ±‚å‘é€ä¹‹åè¢«è°ƒç”¨
     */
    @Override
    public void afterExecute(ForestRequest req, ForestResponse res) {
        log.info("invoke Simple afterExecute");
        // æ‰§è¡Œåœ¨å‘é€è¯·æ±‚ä¹‹åå¤„ç†çš„ä»£ç 
        int status = res.getStatusCode(); // è·å–è¯·æ±‚å“åº”çŠ¶æ€ç 
        String content = res.getContent(); // è·å–è¯·æ±‚çš„å“åº”å†…å®¹
        String result = res.getResult(); // è·å–æ–¹æ³•è¿”å›ç±»å‹å¯¹åº”çš„æœ€ç»ˆæ•°æ®ç»“æœ
    }
}

````
`Interceptor`æ¥å£å¸¦æœ‰ä¸€ä¸ªæ³›å‹å‚æ•°ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯è¯·æ±‚å“åº”åè¿”å›çš„æ•°æ®ç±»å‹ã€‚
Interceptor&lt;String&gt;å³ä»£è¡¨è¿”å›çš„æ•°æ®ç±»å‹ä¸º `String`ã€‚

åœ¨æ‹¦æˆªå™¨çš„æ–¹æ³•å‚æ•°ä¸­åŸºæœ¬éƒ½æœ‰ ForestRequest ç±»å¯¹è±¡ï¼Œå³Forestè¯·æ±‚å¯¹è±¡ï¼ŒForestçš„ç»å¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯å›´ç»•è¯·æ±‚å¯¹è±¡æ‰€ä½œçš„å·¥ä½œã€‚

:::tip æ–‡æ¡£å¯¼èˆª
è¦è¯¦ç»†äº†è§£ Forest è¯·æ±‚å¯¹è±¡å¦‚ä½•ä½¿ç”¨ï¼Œè¯·å‚è§ã€Š[è¯·æ±‚å¯¹è±¡](/pages/1.5.32/api_forest_request/)ã€‹
:::


### æ‹¦æˆªå™¨ä¸ Spring é›†æˆ

è‹¥æˆ‘è¦åœ¨æ‹¦æˆªå™¨ä¸­æ³¨å…¥ Spring çš„ Bean æ”¹å¦‚ä½•åšï¼Ÿ

```java

/**
 * åœ¨æ‹¦æˆªå™¨çš„ç±»ä¸ŠåŠ ä¸Š@Componentæ³¨è§£ï¼Œå¹¶ä¿è¯å®ƒèƒ½è¢«Springæ‰«æåˆ°
 */
@Component
public class SimpleInterceptor implements Interceptor<String> {

    // å¦‚æ­¤ä¾¿èƒ½ç›´æ¥æ³¨å…¥Springä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„Beanäº†
    @Resource
    private UserService userService;
    
    ... ...
}

```

### åœ¨æ‹¦æˆªå™¨ä¸­ä¼ é€’æ•°æ®

åœ¨Forestä¸­ï¼Œæ‹¦æˆªå™¨æ˜¯åŸºäºå•ä¾‹æ¨¡å¼åˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªæ‹¦æˆªå™¨ç±»æœ€å¤šåªèƒ½å¯¹åº”ä¸€ä¸ªæ‹¦æˆªå™¨å®ä¾‹ã€‚

é‚£ä¹ˆä»¥ä¸‹è¿™ç§é€šè¿‡å…±äº«å˜é‡çš„æ–¹å¼å°±å¯èƒ½é€ æˆé”™è¯¯ï¼š

```java
public class SimpleInterceptor implements Interceptor<String> {
  
    private String name;
   
    @Override
    public boolean beforeExecute(ForestRequest req) {
        this.name = req.getQuery("name");
    }

    @Override
    public void onSuccess(String data, ForestRequest req, ForestResponse res) {
        System.out.println("name = " + name);
    }
}
```

è‹¥æœ‰ä¸¤ä¸ªè¯·æ±‚åŒæ—¶è¿›å…¥è¯¥æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚1 url=...?name=A1, è¯·æ±‚2 url=...?name=A2ï¼‰, è€Œæœ€åå½“è¯·æ±‚1è¿›å…¥`onSuccess`æ–¹æ³•æ—¶ï¼Œåº”è¯¥æ‰“å°å‡º `name = A2`ï¼Œå´å› ä¸ºä¹‹å‰æ‰§è¡Œäº†è¯·æ±‚2çš„`beforeExecute`æ–¹æ³•ï¼Œå°†ç±»å˜é‡`name`çš„å€¼æ”¹æˆäº†`A2`,
æ‰€ä»¥æœ€ç»ˆæ‰“å°å‡ºæ¥çš„æ˜¯ `name = A2` ï¼ˆå…¶å®åº”è¯¥æ˜¯ `name = A1`ï¼‰ï¼Œè¿™æ˜æ˜¾æ˜¯é”™è¯¯çš„ã€‚

é‚£è¯¥å¦‚ä½•åšèƒ½åœ¨ä¼ é€’æ•°æ®çš„åŒæ—¶é¿å…è¿™ç±»é—®é¢˜å‘¢ï¼Ÿ 

æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å°†æ‚¨è¦ä¼ é€’çš„æ•°æ®ä¸è¯·æ±‚å¯¹è±¡ç»‘å®šåœ¨ä¸€èµ·ï¼Œæ¯”å¦‚åœ¨ `onSuccess` ä¸­è°ƒç”¨`req.getQuery`æ–¹æ³•ã€‚

```java
System.out.println("name = " + forest.getQuery("name"));
```

è™½ç„¶è¿™ç§æ–¹æ³•èƒ½å¤Ÿè§£å†³å¹¶å‘é—®é¢˜ï¼Œä½†æœ‰ä¸ªæ˜æ˜¾çš„é™åˆ¶ï¼šå¦‚æœè¦ä¼ é€’çš„æ•°æ®ä¸æƒ³å‡ºç°åœ¨è¯·æ±‚ä¸­çš„ä»»ä½•ä½ç½®(åŒ…æ‹¬URLã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“)ï¼Œé‚£å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚

è¿™æ—¶å€™å°±è¦ä½¿ç”¨ `ForestRequest` çš„æ‰©å±•ç»‘å®šæ•°æ®çš„æ–¹æ³•äº†ã€‚

### Attribute

åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨`addAttribute`æ–¹æ³•å’Œ`getAttribute`æ–¹æ³•æ¥æ·»åŠ å’Œè·å–`Attribute`ã€‚

`Attribute` æ˜¯å’Œè¯·æ±‚ä»¥åŠæ‰€åœ¨æ‹¦æˆªå™¨ç»‘å®šçš„å±æ€§å€¼ï¼Œè¿™äº›å±æ€§å€¼ä¸èƒ½é€šè¿‡ç½‘ç»œè¯·æ±‚ä¼ é€’åˆ°è¿œç«¯æœåŠ¡å™¨ã€‚

è€Œä¸”ï¼Œåœ¨ä½¿ç”¨`getAttribute`æ–¹æ³•æ—¶ï¼Œåªèƒ½è·å–åœ¨ç›¸åŒæ‹¦æˆªå™¨ï¼Œä»¥åŠç›¸åŒè¯·æ±‚ä¸­ç»‘å®šçš„`Attribute`ï¼Œè¿™ä¸¤ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯ã€‚

```java
public class SimpleInterceptor implements Interceptor<String> {
  
    @Override
    public void onInvokeMethod(ForestRequest req, ForestMethod method, Object[] args) {
        String methodName = method.getMethodName();
        addAttribute(req, "methodName", methodName); // æ·»åŠ Attribute
        addAttribute(req, "num", (Integer) args[0]); // æ·»åŠ Attribute
    }

    @Override
    public void onSuccess(String data, ForestRequest req, ForestResponse res) {
        Object value1 = getAttribute(req, "methodName");  // è·å–åç§°ä¸ºmethodNameçš„Attributeï¼Œä¸æŒ‡å®šè¿”å›ç±»å‹
        String value2 = getAttribute(req, "methodName", String.class);  // è·å–åç§°ä¸ºmethodNameçš„Attributeï¼Œå¹¶è½¬æ¢ä¸ºæŒ‡å®šçš„Classç±»å‹
        String value3 = getAttributeAsString(req, "methodName");  // è·å–åç§°ä¸ºmethodNameçš„Attributeï¼Œå¹¶è½¬æ¢ä¸ºStringç±»å‹
        Integer value4 = getAttributeAsInteger(req, "num");  // è·å–åç§°ä¸ºnumçš„Attributeï¼Œå¹¶è½¬æ¢ä¸ºIntegerç±»å‹
    }
}
```

### Attachment

å¯ä»¥ä½¿ç”¨`ForestRequest`å¯¹è±¡çš„`addAttachment`æ–¹æ³•å’Œ`getAttachment`æ–¹æ³•æ¥æ·»åŠ å’Œè·å–`Attachment`ã€‚

`Attachment` æ˜¯å’Œè¯·æ±‚ç»‘å®šçš„é™„ä»¶å±æ€§å€¼ï¼Œè¿™äº›å€¼ä¸èƒ½é€šè¿‡ç½‘ç»œè¯·æ±‚ä¼ é€’åˆ°è¿œç«¯æœåŠ¡å™¨ã€‚

è€Œä¸”ï¼Œåœ¨ä½¿ç”¨`getAttachment`æ–¹æ³•æ—¶ï¼Œåªèƒ½è·å–åœ¨ç›¸åŒè¯·æ±‚ä¸­ç»‘å®šçš„`Attachment`ï¼Œä½†ä¸å¿…æ˜¯ç›¸åŒçš„æ‹¦æˆªå™¨ã€‚


```java
public class SimpleInterceptor1 implements Interceptor<String> {
  
    @Override
    public void onInvokeMethod(ForestRequest req, ForestMethod method, Object[] args) {
        String methodName = method.getMethodName();
        req.addAttachment("methodName", methodName); // æ·»åŠ Attachment
        req.addAttachment("num", (Integer) args[0]); // æ·»åŠ Attachment
    }
    ... ...
}

/**
 * Attachmentä¸ä¾èµ–ä»»ä½•ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¯ä»¥è·¨æ‹¦æˆªå™¨ä¼ é€’æ•°æ®
 */
public class SimpleInterceptor2 implements Interceptor<String> {
  
    @Override
    public void onSuccess(String data, ForestRequest req, ForestResponse res) {
        Object value1 = req.getAttachment("methodName");  // è·å–åç§°ä¸ºmethodNameçš„Attachment
        Object value2 = req.getAttachment("num");  // è·å–åç§°ä¸ºnumçš„Attachment
    }
}
```

#### Attributeä¸Attachmentçš„åŒºåˆ«

`Attribute`å’Œ`Attachment`éƒ½æ˜¯èƒ½é€šè¿‡è¯·æ±‚è¿›è¡Œç»‘å®šçš„æ•°æ®ä¼ é€’æ–¹å¼ï¼Œä½†ä¹Ÿæœ‰æ‰€ä¸åŒã€‚

|             | ç»‘å®šè¯·æ±‚ | ç»‘å®šæ‹¦æˆªå™¨ |
| ----------- | ---------| ---------- |
| Attribute  | <font color="green">âœ”</font> | <font color="green">âœ”</font> |
| Attachment | <font color="green">âœ”</font> | <font color="red">âœ˜</font> |


### é…ç½®æ‹¦æˆªå™¨

Forestæœ‰ä¸‰ä¸ªåœ°æ–¹å¯ä»¥æ·»åŠ æ‹¦æˆªå™¨ï¼š`@Request`ã€`@BaseRequest`ã€å…¨å±€é…ç½®ï¼Œè¿™ä¸‰ä¸ªåœ°æ–¹ä»£è¡¨ä¸‰ä¸ªä¸åŒçš„ä½œç”¨åŸŸã€‚

#### @Requestä¸Šçš„æ‹¦æˆªå™¨

è‹¥æ‚¨æƒ³è¦æŒ‡å®šçš„æ‹¦æˆªå™¨åªä½œç”¨åœ¨æŒ‡å®šçš„è¯·æ±‚ä¸Šï¼Œåªéœ€è¦åœ¨è¯¥è¯·æ±‚æ–¹æ³•çš„`@Request`æ³¨è§£ä¸­è®¾ç½®`interceptor`å±æ€§å³å¯ã€‚

```java

public interface SimpleClient {

    @Request(
            url = "http://localhost:8080/hello/user?username=foo",
            headers = {"Accept:text/plain"},
            interceptor = SimpleInterceptor.class
    )
    String simple();
}
```

`@Request`ä¸­æ‹¦æˆªå™¨å¯ä»¥é…ç½®å¤šä¸ª:

```java
    @Request(
            url = "http://localhost:8080/hello/user?username=foo",
            headers = {"Accept:text/plain"},
            interceptor = {SimpleInterceptor1.class, SimpleInterceptor2.class, ...}
    )
    String simple();
```

:::tip å‹æƒ…æç¤º
`@Request`ä¸Šçš„æ‹¦æˆªå™¨åªä¼šæ‹¦æˆªæŒ‡å®šçš„è¯·æ±‚
:::

#### @BaseRequest ä¸Šçš„æ‹¦æˆªå™¨

è‹¥æ‚¨æƒ³ä½¿ä¸€ä¸ª`interface`å†…çš„æ‰€æœ‰è¯·æ±‚æ–¹æ³•éƒ½æŒ‡å®šæŸä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¯ä»¥åœ¨`@BaseRequest`çš„`interceptor`ä¸­è®¾ç½®

```java

@BaseRequest(baseURL = "http://localhost:8080", interceptor = SimpleInterceptor.class)
public interface SimpleClient {

    @Request(url = "/hello/user1?username=foo" )
    String send1();

    @Request(url = "/hello/user2?username=foo" )
    String send2();

    @Request(url = "/hello/user3?username=foo" )
    String send3();
}

```

å¦‚ä»¥ä¸Šä»£ç æ‰€ç¤ºï¼Œ`SimpleClient`æ¥å£ä¸­çš„`send1`ã€`send2`ã€`send3`æ–¹æ³•éƒ½è¢«ä¼š`SimpleInterceptor`æ‹¦æˆªå™¨æ‹¦æˆª

`@BaseRequest`ä¹Ÿå¦‚`@Request`ä¸­çš„`interceptor`å±æ€§ä¸€æ ·ï¼Œå¯ä»¥é…1åˆ°å¤šä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚ä»£ç æ‰€ç¤ºï¼š

```java
@BaseRequest(
    baseURL = "http://localhost:8080", 
    interceptor = {SimpleInterceptor1.class, SimpleInterceptor2.class, ...})
public interface SimpleClient {
    // ... ...
}
```

#### å…¨å±€æ‹¦æˆªå™¨

è‹¥è¦é…ç½®èƒ½æ‹¦æˆªé¡¹ç›®èŒƒå›´æ‰€æœ‰Forestè¯·æ±‚çš„æ‹¦æˆªå™¨ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦åœ¨å…¨å±€é…ç½®ä¸­åŠ ä¸Š`interceptors`å±æ€§å³å¯

```yaml
forest:
  ...
  interceptors:                   # å¯é…ç½®1åˆ°å¤šä¸ªæ‹¦æˆªå™¨
     - com.your.site.client.SimpleInterceptor1
     - com.your.site.client.SimpleInterceptor2
     ...
```
