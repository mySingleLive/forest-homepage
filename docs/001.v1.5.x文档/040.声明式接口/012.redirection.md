---
id: redirection
title: ğŸ¥‚ é‡å®šå‘
date: 2022-07-01 12:44:20
permalink: /pages/1.5.x/redirection/
---

HTTP è¯·æ±‚åœ¨æ¥æ”¶åˆ°`301`ã€`302`ã€`307`ç­‰å“åº”çŠ¶æ€ç æ—¶ï¼Œå°±é»˜è®¤ä¸ºé‡å®šå‘è¯·æ±‚ï¼Œæµè§ˆå™¨å’Œä¸€äº›å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è§¦å‘é‡å®šå‘ï¼Œå³å‘èµ·ä¸€ä¸ªæ–°çš„è¯·æ±‚è·³è½¬åˆ°æ–°çš„URL

## è‡ªåŠ¨é‡å®šå‘

æ‰“å¼€/å…³é—­å…¨å±€è‡ªåŠ¨é‡å®šå‘é…ç½®

```yaml
forest:
  # å…¨å±€è‡ªåŠ¨é‡å®šå‘å¼€å…³ï¼Œé»˜è®¤ä¸ºå¼€å¯
  auto-redirection: true # true ä¸ºå¼€å¯ï¼Œfalse ä¸ºå…³é—­
```
é™¤äº†å…¨å±€å¼€å…³ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ @Redirection æ³¨è§£ï¼Œå®ƒèƒ½æ§åˆ¶åˆ°å…·ä½“çš„æ¥å£å’Œæ–¹æ³•

```java
// æ‰“å¼€æ•´ä¸ªæ¥å£çš„è‡ªåŠ¨é‡å®šå‘
@Redirection
public interface MyTestClient1 {

    // é»˜è®¤æ¥å£é…ç½®çš„é‡å®šå‘å¼€å…³ï¼Œå³æ‰“å¼€è‡ªåŠ¨é‡å®šå‘
    @Get("/")
    String getData1();


    // å…³é—­æŸä¸ªæ–¹æ³•çš„é‡å®šå‘
    @Redirection(false)
    @Get("/")
    String getData2();
    
    ... ...
}

// å…³é—­æ•´ä¸ªæ¥å£æ–¹æ³•çš„è‡ªåŠ¨é‡å®šå‘
@Redirection(false)
public interface MyTestClient2 {

    // é»˜è®¤æ¥å£é…ç½®çš„é‡å®šå‘å¼€å…³ï¼Œå³å…³é—­è‡ªåŠ¨é‡å®šå‘
    @Get("/")
    String getData1();

    // æ‰“å¼€æŸä¸ªæ–¹æ³•çš„é‡å®šå‘
    @Redirection
    @Get("/")
    String getData2();
    
    ... ...
}

```

## å¤„ç†å’Œè·å–é‡å®šå‘ä¿¡æ¯

### ä½¿ç”¨æ‹¦æˆªå™¨å¤„ç†é‡å®šå‘

å¯¹äºè‡ªåŠ¨é‡å®šå‘çš„è¯·æ±‚æ¥è¯´ï¼Œæ— æ³•é€šè¿‡è¯·æ±‚æ–¹æ³•è¿”å›å¾—åˆ°è·³è½¬å‰çš„è¯·æ±‚/å“åº”ä¿¡æ¯ï¼Œæ‰€ä»¥å¾—é€šè¿‡æ‹¦æˆªå™¨æ¥å¤„ç†

æ‹¦æˆªå™¨çš„ `onRedirection` æ–¹æ³•ä¼šåœ¨é‡å®šå‘è·³è½¬è¯·æ±‚å‘é€å‰è§¦å‘ï¼Œä»¥æ­¤è·å¾—ä»¥ä¸€æ¬¡çš„Requestå’ŒResponseå¯¹è±¡ï¼Œ
å³è¿”å› `301`ã€`302` ç­‰çŠ¶æ€ç çš„å“åº”å¯¹è±¡

åŒæ—¶ï¼Œè¿˜èƒ½å¯¹åœ°å€è½¬ç§»è¯·æ±‚åšä¿®æ”¹

```java
/**
 * åœ¨æ‹¦æˆªå™¨ä¸­å¯ä»¥é‡å†™ onRedirection æ–¹æ³•
 * è¯¥æ–¹æ³•å¯ä»¥è·å–å’Œå¤„ç†é‡å®šå‘è¯·æ±‚ç›¸å…³ä¿¡æ¯
 */
public class RedirectInterceptor implements Interceptor<Object> {

    @Override
    public void onRedirection(ForestRequest<?> redirectReq, ForestRequest<?> prevReq, ForestResponse<?> prevRes) {
        // è·å–è·³è½¬å‰çš„è¯·æ±‚ä¿¡æ¯
        String prevUrl = prevReq.getUrl();
        // è·å–è·³è½¬å‰çš„å“åº”ä¿¡æ¯
        String location = prevRes.getHeader("Location");
        // å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å¯¹å³å°†è·³è½¬çš„æ–°è¯·æ±‚åšä¿®æ”¹
        redirectReq.addBody("foo", "bar");
    }
}
```

### ä½¿ç”¨ ForestResponse å¤„ç†é‡å®šå‘

å¯¹äºå·²ç»å…³é—­è‡ªåŠ¨é‡å®šå‘çš„è¯·æ±‚æ¥è¯´ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡æ–¹æ³•è¿”å›çš„è·³è½¬å‰çš„å“åº”å¯¹è±¡ï¼ˆå³è·å¾—`301`ã€`302`ç­‰çŠ¶æ€ç çš„å“åº”å¯¹è±¡ï¼‰

```java
/**
 * å…³é—­äº†è‡ªåŠ¨é‡å®šå‘
 * éœ€è¦å°†æ–¹æ³•è¿”å›å€¼è®¾ä¸º ForestResponse ç±»å‹
 */
@Redirection(false)
@Get("/")
ForestResponse<String> getData();
```
é€šè¿‡`ForestReposne.isRedirection()`åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘è·³è½¬ï¼Œå†é€šè¿‡`ForestResponse.redirectionRequest()`è·å–é‡å®šå‘Urlè½¬ç§»è¯·æ±‚å¯¹è±¡

```java
// è°ƒç”¨æ¥å£è·å¾—è½¬ç§»å‰çš„å“åº”å¯¹è±¡
ForestResponse<String> response = client.getData();
// åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘è·³è½¬
if (response.isRedirection()) {
    // è·å¾—å³å°†è·³è½¬çš„è¯·æ±‚å¯¹è±¡
    ForestRequest redirectReq = response.redirectionRequest();
    // å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å¯¹æ·»åŠ è¯·æ±‚è¿›è¡Œä¿®æ”¹
    redirectReq.addBody("foo", "bar");
    // æ‰§è¡Œè·³è½¬
    String result = redirectReq.executeAsString();
}
```

## é‡å®šå‘æ—¥å¿—

åœ¨å¼€å¯è‡ªåŠ¨é‡å®šå‘çš„æƒ…å†µä¸‹ï¼Œé‡å®šå‘çš„è¯·æ±‚æ—¥å¿—å½¢å¼å¦‚ä¸‹

```
[Forest] Request (okhttp3):
	[Redirect]: From POST http://localhost:59006/ -> 301
	POST http://localhost:59006/b HTTP
```

```
[Forest] Request (httpclient):
	[Redirect]: From POST http://localhost:59006/c -> 301
	POST http://localhost:59006/d HTTP
```


