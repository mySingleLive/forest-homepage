---
id: https
title: ğŸ›¡ï¸ HTTPS
date: 2022-07-01 12:44:20
permalink: /pages/1.5.28/https/
---

ä¸ºä¿è¯ç½‘ç»œè®¿é—®å®‰å…¨ï¼Œç°åœ¨å¤§å¤šæ•°ä¼ä¸šéƒ½ä¼šé€‰æ‹©ä½¿ç”¨SSLéªŒè¯æ¥æé«˜ç½‘ç«™çš„å®‰å…¨æ€§ã€‚
 
æ‰€ä»¥Forestè‡ªç„¶ä¹ŸåŠ å…¥äº†å¯¹HTTPSçš„å¤„ç†ï¼Œç°åœ¨æ”¯æŒå•å‘è®¤è¯å’ŒåŒå‘è®¤è¯çš„HTTPSè¯·æ±‚ã€‚

## å•å‘è®¤è¯

å¦‚æœè®¿é—®çš„ç›®æ ‡ç«™ç‚¹çš„SSLè¯ä¹¦ç”±ä¿¡ä»»çš„Root CAå‘å¸ƒçš„ï¼Œé‚£ä¹ˆæ‚¨æ— éœ€åšä»»ä½•äº‹æƒ…ä¾¿å¯ä»¥è‡ªåŠ¨ä¿¡ä»»

```java

public interface Gitee {
    @Request(url = "https://gitee.com")
    String index();
}
```

Forestçš„å•å‘éªŒè¯çš„é»˜è®¤åè®®ä¸º`TLS`ï¼Œå¦‚æœä¸€äº›ç«™ç‚¹çš„APIä¸æ”¯æŒè¯¥åè®®ï¼Œæ‚¨å¯ä»¥åœ¨å…¨å±€é…ç½®ä¸­å°†`ssl-protocol`å±æ€§ä¿®æ”¹ä¸ºå…¶å®ƒåè®®ï¼Œå¦‚ï¼š`SSL`, `TLS`, `TLSv1.1`, `TLSv1.2`,`TLSv1.3`, `SSLv3`ç­‰ç­‰ã€‚  

```yaml
forest:
  ...
  ssl-protocol: TLS
```


å…¨å±€é…ç½®å¯ä»¥é…ç½®ä¸€ä¸ªå…¨å±€ç»Ÿä¸€çš„SSLåè®®ï¼Œä½†ç°å®æƒ…å†µæ˜¯æœ‰å¾ˆå¤šä¸åŒæœåŠ¡ï¼ˆå°¤å…¶æ˜¯ç¬¬ä¸‰æ–¹ï¼‰çš„APIä¼šä½¿ç”¨ä¸åŒçš„SSLåè®®ï¼Œè¿™ç§æƒ…å†µéœ€è¦é’ˆå¯¹ä¸åŒçš„æ¥å£è®¾ç½®ä¸åŒçš„SSLåè®®ã€‚

```java
/**
 * åœ¨æŸä¸ªè¯·æ±‚æ¥å£ä¸Šé€šè¿‡ sslProtocol å±æ€§è®¾ç½®å•å‘SSLåè®®
 */
@Get(
    url = "https://localhost:5555/hello/user",
    sslProtocol = "TLS"
)
ForestResponse<String> truestSSLGet();
```

åœ¨ä¸€ä¸ªä¸ªæ–¹æ³•ä¸Šè®¾ç½®å¤ªéº»çƒ¦ï¼Œä¹Ÿå¯ä»¥åœ¨ `@BaseRequest` æ³¨è§£ä¸­è®¾ç½®ä¸€æ•´ä¸ªæ¥å£ç±»çš„SSLåè®®

```java
@BaseRequest(sslProtocol = "TLS")
public interface SSLClient {

    @Get("https://localhost:5555/hello/user")
    String testSend();

}
```

## ç®€å•åŒå‘è®¤è¯

 è‹¥æ˜¯éœ€è¦åœ¨Forestä¸­è¿›è¡ŒåŒå‘éªŒè¯çš„HTTPSè¯·æ±‚ï¼Œä¹Ÿå¾ˆç®€å•ã€‚
 
 åœ¨å…¨å±€é…ç½®ä¸­æ·»åŠ `keystore`é…ç½®ï¼š

<code-group>
<code-block title="SpringBoot" active>

 
 ```yaml
forest:
  ...
  ssl-key-stores:
    - id: keystore1           # idä¸ºè¯¥keystoreçš„åç§°ï¼Œå¿…å¡«
      file: test.keystore     # å…¬é’¥æ–‡ä»¶åœ°å€
      keystore-pass: 123456   # keystoreç§˜é’¥
      cert-pass: 123456       # certç§˜é’¥
      protocols: TLS          # SSLåè®®
```
</code-block>

<code-block title="Spring">

```xml
<forest:configuration>
    <forest:ssl-keystore
            id="keystore1"
            file="test.keystore"
            keystorePass="123456"
            certPass="123456"
            protocols="TLS"/>
</forest:configuration>
```

</code-block>

<code-block title="Java">

```java
// è·å–Forestå…¨å±€é…ç½®å¯¹è±¡
configuration = Forest.config();
// å®ä¾‹åŒ– SSLKeyStore å¯¹è±¡ï¼Œå¹¶è¾“å…¥å‚æ•°
SSLKeyStore sslKeyStore = new SSLKeyStore(
    "keystore1",
    "ssl_client.keystore",
    "client",
    "456789",
    null,
    null);
// æ³¨å†Œ SSLKeyStore å¯¹è±¡
configuration.registerKeyStore(sslKeyStore);
```

</code-block>
</code-group>

æ¥ç€ï¼Œåœ¨`@Request`ä¸­å¼•å…¥è¯¥`keystore`çš„`id`å³å¯

```java
@Get(url = "/user_info", keyStore = "keystore1")
ForestResponse<String> getUserInfo();
```

å¦å¤–ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨å…¨å±€é…ç½®ä¸­é…å¤šä¸ª`keystore`ï¼š

```yaml
forest:
  ...
  ssl-key-stores:
    - id: keystore1          # ç¬¬ä¸€ä¸ªkeystore
      file: test1.keystore    
      keystore-pass: 123456  
      cert-pass: 123456      
      protocols: SSL       

    - id: keystore2          # ç¬¬äºŒä¸ªkeystore
      file: test2.keystore    
      keystore-pass: abcdef  
      cert-pass: abcdef      
      protocols: TLS       
      ...
```

éšååœ¨æŸä¸ªå…·ä½“`@Request`ä¸­é…ç½®å…¶ä¸­ä»»æ„ä¸€ä¸ª`keystore`çš„`id`éƒ½å¯ä»¥


## æ›´å¤æ‚çš„SSLéªŒè¯

å¯¹äºä¸€äº›æ›´å¤æ‚çš„SSLéªŒè¯ï¼Œå…‰é ç®€å•çš„é…ç½®æ— æ³•å®Œå…¨åº”ä»˜ï¼Œä½†åœ¨Forestä¸­ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰`SSLSocketFactory`å’Œ`HostnameVerifier`çš„æ–¹å¼æä¾›æ›´çµæ´»çš„è§£å†³æ–¹æ¡ˆ

### è‡ªå®šä¹‰SSLSocketFactory

Forestæä¾›äº†`SSLSocketFactoryBuilder`æ¥å£ï¼Œé€šè¿‡å®ç°è¯¥æ¥å£å¯ä»¥è‡ªå®šä¹‰`SSLSocketFactory`

```java
/**
 * è‡ªå®šä¹‰ SSLSocketFactory æ„é€ å™¨
 */
public class MySSLSocketFactoryBuilder implements SSLSocketFactoryBuilder {

    /**
     * è·å–SSL Socket Factory
     */
    @Override
    public SSLSocketFactory getSSLSocketFactory(ForestRequest request, String protocol) throws Exception {
        SSLContext sslContext = SSLContext.getInstance("TLS");
        sslContext.init(null,
                new TrustManager[] { new TrustAllManager() },
                new SecureRandom());
        return sslContext.getSocketFactory();
    }
}
```

ç„¶åé€šè¿‡`@SSLSocketFactoryBuilder`æ³¨è§£å¼•å…¥è‡ªå®šä¹‰çš„`SSLSocketFactoryBuilder`æ¥å£å®ç°ç±»

```java
@Get("/user_info")
@SSLSocketFactoryBuilder(MySSLSocketFactoryBuilder.class)
ForestRequest<String> getUserInfo();
```


### è‡ªå®šä¹‰HostnameVerifier

åœ¨Forestä¸­ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„`HostnameVerifier`æ¥å£å®ç°ç±»

```java
/**
 * è‡ªå®šä¹‰ä¸»æœºåéªŒè¯å™¨
 */
public class MyHostnameVerifier implements HostnameVerifier {
    @Override
    public boolean verify(String s, SSLSession sslSession) {
        System.out.println("do MyHostnameVerifier");
        if ("localhost".equals(s)) {
            return false;
        }
        return true;
    }
}
```
ç„¶åé€šè¿‡`@SSLHostnameVerifier`æ³¨è§£å¼•å…¥è‡ªå®šä¹‰çš„ä¸»æœºåéªŒè¯å™¨ç±»

```java
@Get("/user_info")
@SSLHostnameVerifier(MyHostnameVerifier.class)
ForestRequest<String> getUserInfo();
```

