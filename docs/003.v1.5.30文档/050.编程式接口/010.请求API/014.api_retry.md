---
id: api_retry
title: ğŸŒ¶ï¸ é‡è¯•æœºåˆ¶
date: 2022-07-14 12:44:11
permalink: /pages/1.5.30/api_retry/
---

ForestRequest å¯¹è±¡æä¾›äº†è®¾ç½®é‡è¯•ç›¸å…³å±æ€§çš„æ–¹æ³•

æ˜¯å¦è¿è¡Œé‡è¯• (é»˜è®¤ä¸ºå¼€å¯é‡è¯•)

> `setRetryEnabled(boolean retryEnabled)` è®¾ç½®æ˜¯å¦å¼€å¯è¯·æ±‚é‡è¯•
>- å‚æ•°`retryEnabled`: `true` å¼€å¯é‡è¯•ï¼Œ`false` å…³é—­é‡è¯•

```java
// å¼€å¯è¯·æ±‚é‡è¯•ï¼ˆé»˜è®¤å³å¼€å¯ï¼‰
request.setRetryEnabled(true);
// å…³é—­è¯·æ±‚é‡è¯•ï¼ˆå…³é—­åè¯¥è¯·æ±‚ä¸ä¼šå†è§¦å‘é‡è¯•ï¼‰
request.setRetryEnabled(false);
```

è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•° (é»˜è®¤ä¸º`0`æ¬¡ï¼Œå³ä¸ä¼šé‡è¯•)

> `maxRetryCount(int retryCount)` è®¾ç½®è¯·æ±‚å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°
>- å‚æ•°`retryCount`: é‡è¯•æ¬¡æ•°

```java
// è®¾ç½®è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•°ä¸º 3 æ¬¡
request.maxRetryCount(3);
```

è®¾ç½®æœ€å¤§è¯·é‡è¯•çš„æ—¶é—´é—´éš” (æ—¶é—´å•ä½ä¸ºæ¯«ç§’, é»˜è®¤ä¸º`0`æ¯«ç§’)

> `maxRetryInterval(long maxRetryInterval)` è®¾ç½®æœ€å¤§è¯·é‡è¯•çš„æ—¶é—´é—´éš”
>- å‚æ•°`maxRetryInterval`: æœ€å¤§è¯·é‡è¯•çš„æ—¶é—´é—´éš” (æ¯«ç§’)

```java
// è®¾ç½®è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•°ä¸º 10ms
request.maxRetryInterval(10L);
```

## é‡è¯•å™¨

Retryer é‡è¯•å™¨ï¼Œå³é‡è¯•ç­–ç•¥ï¼Œå¯ä»¥è®¾å®šæ¯æ¬¡é‡è¯•è¯·æ±‚ä¹‹é—´çš„æ—¶é—´é—´éš”

Forest é»˜è®¤é‡è¯•å™¨ç±»ä¸º `com.dtflys.forest.retryer.BackOffRetryer`ï¼Œå®ƒæ˜¯ä¾æ®äºŒè¿›åˆ¶é€€é¿ç®—æ³•çš„é‡è¯•ç­–ç•¥ç±»

è‹¥é…ç½®è¯¥é‡è¯•å™¨ï¼Œé‡è¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ¬¡é‡è¯•ä¸ç¬¬ä¸€æ¬¡è¯·æ±‚ä¹‹é—´é—´éš” 0çš„2æ¬¡æ–¹ * 1s, å³0s
- ç¬¬äºŒæ¬¡é‡è¯•ä¸ç¬¬ä¸€æ¬¡é‡è¯•ä¹‹é—´é—´éš” 1çš„2æ¬¡æ–¹ * 1s, å³1s
- ç¬¬ä¸‰æ¬¡æ¬¡é‡è¯•ä¸ç¬¬äºŒæ¬¡é‡è¯•ä¹‹é—´é—´éš” 2çš„2æ¬¡æ–¹ * 1s, å³4s
- åé¢å‡ æ¬¡é‡è¯•æ—¶é—´é—´éš”ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§è¯·æ±‚æ¬¡æ•°ååœæ­¢é‡è¯•
- æ¯æ¬¡æ—¶é—´é—´éš”ä¸èƒ½å¤§äº `maxRetryInterval`, è‹¥ `maxRetryInterval` è®¾ç½®ä¸º `10`, åˆ™æ¯æ¬¡é—´éš”åªèƒ½ä¸º `10ms`

æ‚¨ä¹Ÿå¯ä»¥è‡ªå®šä¹‰é‡è¯•å™¨

```java
// è‡ªå®šä¹‰é‡è¯•å™¨
// ç»§æ‰¿ BackOffRetryer ç±»
public class MyRetryer extends BackOffRetryer {

    public MyRetryer(ForestRequest request) {
        super(request);
    }

    /**
     * é‡å†™ nextInterval æ–¹æ³•
     * è¯¥æ–¹æ³•ç”¨äºæŒ‡å®šæ¯æ¬¡é‡è¯•çš„æ—¶é—´é—´éš”
     * @param currentCount å½“å‰é‡è¯•æ¬¡æ•°
     * @return æ—¶é—´é—´éš” (æ—¶é—´å•ä½ä¸ºæ¯«ç§’)
     */
    @Override
    protected long nextInterval(int currentCount) {
        // æ¯æ¬¡é‡è¯•æ—¶é—´é—´éš”æ’å®šä¸º 1s (1000ms)
        return 1000;
    }
}
```

å†é€šè¿‡ ForestRequest å¯¹è±¡çš„ `retryer(Class<? extends ForestRetryer> retryerClass)` è®¾ç½®è¯¥è‡ªå®šä¹‰é‡è¯•å™¨ç±»

```java
// è®¾ç½®è‡ªå®šä¹‰é‡è¯•å™¨ç±»
request.retryer(MyRetryer.class);
```

## é‡è¯•æ¡ä»¶

Forest è¯·æ±‚çš„é‡è¯•æ¡ä»¶æœ‰ä¸¤ç§è®¾ç½®æ¨¡å¼:
- å°† [SuccessWhen è¯·æ±‚æˆåŠŸ/å¤±è´¥æ¡ä»¶](/pages/1.5.30/api_success/) ä½œä¸ºé‡è¯•æ¡ä»¶
- è®¾ç½® RetryWhen é‡è¯•æ¡ä»¶

ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šè®¾ç½® RetryWhen é‡è¯•æ¡ä»¶ï¼Œå³ç›´é€šè¿‡è¯·æ±‚çš„æˆåŠŸ/å¤±è´¥æ¥åˆ¤æ–­æ˜¯å¦é‡è¯•ï¼Œé€»è¾‘å¾ˆç®€å•ï¼šè¯·æ±‚æˆåŠŸä¸é‡è¯•ï¼Œå¤±è´¥å°±é‡è¯•

ä½†æœ‰äº›ç‰¹æ®Šæƒ…å†µï¼Œéœ€è¦åœ¨è¯·æ±‚æˆåŠŸçš„æƒ…å†µä¸‹ä¹Ÿé‡è¯•ï¼Œæ»¡è¶³ä¸€å®šä¸šåŠ¡æ¡ä»¶åæ‰åœæ­¢é‡è¯•ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦ RetryWhen é‡è¯•æ¡ä»¶ä¸Šåœºäº†

> `retryWhen(RetryWhen retryWhen)` è®¾ç½®é‡è¯•æ¡ä»¶ï¼šç”¨äºåˆ¤æ–­è¯·æ±‚æ˜¯å¦è§¦å‘é‡è¯•
>- å‚æ•°`retryWhen`: RetryWhen æ¥å£å®ä¾‹

```java
Forest.get("/")
     // æœ€å¤§é‡è¯•æ¬¡æ•°ä¸º 3
    .maxRetryCount(3)
     // æœ€å¤§é‡è¯•é—´éš”ä¸º 10ms
    .maxRetryInterval(10)
     // é‡è¯•æ¡ä»¶: çŠ¶æ€ç ä¸º 203 å°±é‡è¯•
    .retryWhen(((req, res) -> res.statusIs(203)))
     // onSuccesså›è°ƒå‡½æ•°: æˆåŠŸæ—¶è°ƒç”¨
    .onSuccess((data, req, res) -> {
        System.out.println("æˆåŠŸ!")
    })
     // æ‰§è¡Œè¯·æ±‚
    .execute();
// è‹¥å‘é€è¯·æ±‚åï¼ŒæœåŠ¡ç«¯è¿”å› 203 çŠ¶æ€ç 
// å°±ä¸æ–­è§¦å‘é‡è¯•
// ç›´åˆ°æœåŠ¡ç«¯ä¸è¿”å› 203ï¼Œæˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•
// è‹¥æœ€åä¸€æ¬¡é‡è¯•æœåŠ¡ç«¯å‘é€çš„è¿˜æ˜¯ 203ï¼Œåˆ™è®¤ä¸ºè¯·æ±‚æˆåŠŸï¼Œæ‰§è¡Œ onSuccess
```


å…ˆå®šä¹‰è‡ªå®šä¹‰è¯·æ±‚é‡è¯•å®ç°ç±»

```java
// è‡ªå®šä¹‰é‡è¯•æ¡ä»¶ç±»
// éœ€è¦å®ç° RetryWhen æ¥å£
public class MyRetryCondition implements RetryWhen {
    /**
     * è¯·æ±‚é‡è¯•æ¡ä»¶
     * @param req Forestè¯·æ±‚å¯¹è±¡
     * @param res Forestå“åº”å¯¹è±¡
     * @return true é‡è¯•ï¼Œfalse ä¸é‡è¯•
     */
    @Override
    public boolean retryWhen(ForestRequest req, ForestResponse res) {
        // å“åº”çŠ¶æ€ç ä¸º 203 å°±é‡è¯•
        return res.statusIs(203);
    }
}
```

å†é€šè¿‡è°ƒç”¨ `retryWhen(Class<? extends RetryWhen> conditionClass)` æ–¹æ³•è®¾ç½®è‡ªå®šä¹‰é‡è¯•æ¡ä»¶ç±»

```java
Forest.get("/")
     // æœ€å¤§é‡è¯•æ¬¡æ•°ä¸º 3
    .maxRetryCount(3)
     // æœ€å¤§é‡è¯•é—´éš”ä¸º 10ms
    .maxRetryInterval(10)
     // é‡è¯•æ¡ä»¶: çŠ¶æ€ç ä¸º 203 å°±é‡è¯•
    .retryWhen(MyRetryCondition.class)
     // onSuccesså›è°ƒå‡½æ•°: æˆåŠŸæ—¶è°ƒç”¨
    .onSuccess((data, req, res) -> {
        System.out.println("æˆåŠŸ!");
    })
     // æ‰§è¡Œè¯·æ±‚
    .execute();
// è‹¥å‘é€è¯·æ±‚åï¼ŒæœåŠ¡ç«¯è¿”å› 203 çŠ¶æ€ç 
// å°±ä¸æ–­è§¦å‘é‡è¯•
// ç›´åˆ°æœåŠ¡ç«¯ä¸è¿”å› 203ï¼Œæˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•
// è‹¥æœ€åä¸€æ¬¡é‡è¯•æœåŠ¡ç«¯å‘é€çš„è¿˜æ˜¯ 203ï¼Œåˆ™è®¤ä¸ºè¯·æ±‚æˆåŠŸï¼Œæ‰§è¡Œ onSuccess
```
