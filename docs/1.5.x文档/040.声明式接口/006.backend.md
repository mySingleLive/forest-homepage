---
id: backend
title: 后端框架
sidebar_label: 后端框架
date: 2022-07-01 12:44:20
permalink: /pages/backend/
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


在之前的章节中我们已经介绍过，Forest分为前端和后端两部分，而后端是由`okhttp3`和`httpclient`这样的后端HTTP框架构成的

##  为何需要不同的后端框架

可能有些小伙伴会有疑问，既然某一种HTTP包（比如`okhttp3`）可以作为后端的底层HTTP框架，已提供了日常所有的HTTP请求访问功能，为何还再支持另一种不同的HTTP框架作为后端呢？

这是因为没有一种框架都是完美的，都有各自的优缺点以及差异，比如`okhttp3`接入相对简单、同步异步容易切换，但很难支持带请求体的GET请求这种非标准的畸形请求（但往往业务中需要这种类型请求）;
而`httpclient(5.0版本以下)`性能较好，支持各种标准和非标准请求，但接入较为麻烦，还需要依赖很多的jar包，且不支持`HTTP/2`协议

Forest在某种程度上可以被理解为是一个屏蔽层，尽可能地屏蔽不同后端底层HTTP框架之间的差异，比如有统一的接口调用方式、统一的配置等等，但还是有些底层的特性差异是Forest无能为力的，比如让`okhttp3`的GET请求携带Body这件事就难以做到

对于这样的问题，Forest给出的解决方案就是组合使用不同的后端框架，换句话说就是在需要的地方使用相应的后端框架

## 全局后端框架

Forest有一个全局唯一的后端，并以此为HTTP请求的默认后端，默认情况下为`okhttp3`

<Tabs>
<TabItem value="Yaml" label="Yaml" default>

```yaml
# 设置全局后端框架
# 目前版本有两种选择：okhttp3 和 httpclient
# 不填的默认请求为 okhttp3

forest:
    backend: httpclient # 设置全局后端为 httpclient
```

```yaml
forest:
    backend: okhttp3 # 设置全局后端为 okhttp3
```

</TabItem>
<TabItem value="Properties" label="Properties">

```properties
# 设置全局后端框架
# 目前版本有两种选择：okhttp3 和 httpclient
# 不填的默认请求为 okhttp3

# 设置全局后端为 httpclient
forest.backend=httpclient
```

```properties
# 设置全局后端为 okhttp3
forest.backend=okhttp3
```

</TabItem>

<TabItem value="Spring" label="Spring">

```xml
<!-- backend 后端HTTP API： httpclient -->
<forest:configuration
    ... ...
    backend="httpclient">
... ...
</forest:configuration>
```

```xml
<!-- backend 后端HTTP API： okhttp3 -->
<forest:configuration
    ... ...
    backend="okhttp3">
... ...
</forest:configuration>
```

</TabItem>
<TabItem value="Java" label="Java">

```java
// 目前版本有两种选择：okhttp3 和 httpclient
// 不填的默认请求为 okhttp3

// 获取全局默认配置对象
ForestConfiguration configuration = Forest.config();
// 设置全局后端为 httpclient
configuration.setBackend(new HttpclientBackend());
```

```java
// 获取Forest全局配置对象
ForestConfiguration configuration = Forest.config();
// 设置全局后端框架为 okhttp3
configuration.setBackend(new OkHttp3Backend());
```

</TabItem>
</Tabs>



如果要通过代码方式设置后端框架，建议将后端对象作为静态常量常驻于内存，而不是经常重复实例化同样的后端对象

```java
public class MyBackend {
    // httpclient 后端对象
    public final static HttpclientBackend HTTPCLIENT = new HttpclientBackend();
    // okhttp3 后端对象
    public final static OkHttp3Backend OKHTTP3 = new OkHttp3Backend();
}
```
```java
// 获取Forest全局配置对象
ForestConfiguration configuration = Forest.config();
// 设置全局后端框架为 httpclient
configuration.setBackend(MyBackend.HTTPCLIENT);
```

```java
// 获取Forest全局配置对象
ForestConfiguration configuration = Forest.config();
// 设置全局后端框架为 okhttp3
configuration.setBackend(MyBackend.OKHTTP3);
```

## 接口/请求后端框架

全局后端框架可以配置和切换，甚至可以进行动态切换，但很多时候需要同时使用不同的后端框架，比如两个不同的接口分别使用不同的后端

自`1.5.5`版本后，Forest支持了接口/请求级别的后端框架配置，方便HTTP请求灵活设置后端

### 后端快捷注解

Forest提供了 `@HttpClient` 注解和 `OkHttp3` 注解，分别用于绑定请求的后端为 `httpclient` 和 `okhttp3`

```java
// 绑定请求的后端为 httpclient
@HttpClient
@Post("/data1")
String send1(@Body MyUser user);

// 绑定请求的后端为 okhttp3
@OkHttp3
@Post("/data2")
String send2(@Body MyUser user);
```
如果此类注解也绑定到接口上，那么该接口下的所有方法的请求默认为该接口注解指定的后端框架

```java

// 设置该请求接口的后端框架默认为 httpclient
@HttpClient
public interface BackendClient2 {

    // 未设置请求的后端，则默认为接口指定的后端框架，即 httpclient
    @Post("/data1")
    String send1(@Body MyUser user);

    // 绑定请求的后端为 okhttp3
    @OkHttp3
    @Post("/data2")
    String send2(@Body MyUser user);
}

```

### @Backend 注解

还有一种更为灵活和通用的注解 `@Backend`, 可以通过传入的字符串参数来确定具体要绑定的后端框架

```java
// 设置该请求接口的后端框架默认为 httpclient
@Backend("httpclient")
public interface BackendClient2 {

    // 未设置请求的后端，则默认为接口指定的后端框架，即 httpclient
    @Post("/data1")
    String send1(@Body MyUser user);

    // 绑定请求的后端为 okhttp3
    @Backend("okhttp3")
    @Post("/data2")
    String send2(@Body MyUser user);
}

```

该注解的参数也支持字符串模板，即可以通过全局变量和参数来动态传入

```java
@Backend("{0}")
@Post("/data")
String send(String backend, @Body MyUser user);
```
:::info 提示
对于如何在非 spring/springboot 项目中通过代码设置后端框架，请参见《[请求对象 - 后端框架](/docs/basic/request#后端框架)》
:::
