---
id: upload_download
title: ğŸ‰ ä¸Šä¼ ä¸‹è½½
date: 2022-07-01 12:44:20
permalink: /pages/1.6.x/upload_download/
---


Forestä» `1.4.0` ç‰ˆæœ¬å¼€å§‹æ”¯æŒå¤šç§å½¢å¼çš„æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½åŠŸèƒ½

### è¡¨å•æ–‡ä»¶ä¸Šä¼ 

Forest æä¾›äº†`@DataFile`æ³¨è§£ï¼Œä½¿ç”¨è¯¥æ³¨è§£æ ‡æ³¨å‚æ•°åï¼Œè¯¥æ¥å£æ–¹æ³•çš„è¯·æ±‚ ContentType ä¼šè¢«é»˜è®¤è®¾ç½®ä¸º`multipart/form-data`ï¼Œä¹Ÿå°±æ˜¯è¡¨å•æ–‡ä»¶ä¸Šä¼ çš„è¯·æ±‚ç±»å‹

è€Œè¢«`@DataFile`æ³¨è§£æ ‡æ³¨çš„å‚æ•°ï¼Œä¼šè¢«è§†ä¸ºéœ€è¦ä¸Šä¼ çš„æ–‡ä»¶

```java
/**
 * ç”¨@DataFileæ³¨è§£ä¿®é¥°è¦ä¸Šä¼ çš„å‚æ•°å¯¹è±¡
 * OnProgresså‚æ•°ä¸ºç›‘å¬ä¸Šä¼ è¿›åº¦çš„å›è°ƒå‡½æ•°
 */
@Post(url = "/upload")
Map upload(@DataFile("file") String filePath, OnProgress onProgress);
```

è°ƒç”¨ä¸Šä¼ æ¥å£ä»¥åŠç›‘å¬ä¸Šä¼ è¿›åº¦çš„ä»£ç å¦‚ä¸‹ï¼š

```java
Map result = myClient.upload("D:\\TestUpload\\xxx.jpg", progress -> {
    System.out.println("total bytes: " + progress.getTotalBytes());   // æ–‡ä»¶å¤§å°
    System.out.println("current bytes: " + progress.getCurrentBytes());   // å·²ä¸Šä¼ å­—èŠ‚æ•°
    System.out.println("progress: " + Math.round(progress.getRate() * 100) + "%");  // å·²ä¸Šä¼ ç™¾åˆ†æ¯”
    if (progress.isDone()) {   // æ˜¯å¦ä¸Šä¼ å®Œæˆ
        System.out.println("--------   Upload Completed!   --------");
    }
});
```

åœ¨æ–‡ä»¶ä¸Šä¼ çš„æ¥å£å®šä¹‰ä¸­ï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºæ–‡ä»¶è·¯å¾„å¤–ï¼Œè¿˜å¯ä»¥ç”¨ä»¥ä¸‹å‡ ç§ç±»å‹çš„å¯¹è±¡è¡¨ç¤ºè¦ä¸Šä¼ çš„æ–‡ä»¶:

```java
/**
 * Fileç±»å‹å¯¹è±¡
 */
@Post(url = "/upload")
Map upload(@DataFile("file") File file, OnProgress onProgress);

/**
 * byteæ•°ç»„
 * ä½¿ç”¨byteæ•°ç»„å’ŒInputstreamå¯¹è±¡æ—¶ä¸€å®šè¦å®šä¹‰fileNameå±æ€§
 */
@Post(url = "/upload")
Map upload(@DataFile(value = "file", fileName = "${1}") byte[] bytes, String filename);

/**
 * Inputstream å¯¹è±¡
 * ä½¿ç”¨byteæ•°ç»„å’ŒInputstreamå¯¹è±¡æ—¶ä¸€å®šè¦å®šä¹‰fileNameå±æ€§
 */
@Post(url = "/upload")
Map upload(@DataFile(value = "file", fileName = "${1}") InputStream in, String filename);

/**
 * Spring Web MVC ä¸­çš„ MultipartFile å¯¹è±¡
 */
@PostRequest(url = "/upload")
Map upload(@DataFile(value = "file") MultipartFile multipartFile, OnProgress onProgress);

/**
 * Spring çš„ Resource å¯¹è±¡
 */
@Post(url = "/upload")
Map upload(@DataFile(value = "file") Resource resource);
```

### å¸¦ä¸Šè¡¨å•å‚æ•°

åœ¨ä½¿ç”¨äº†`@DataFile`æ³¨è§£æˆ–æ˜¯ ContentType ä¸º`multipart/form-data`çš„è¯·æ±‚æ–¹æ³•ä¸­ï¼Œè‹¥è¦å¸¦ä¸Šå…¶ä»–å­—ç¬¦ä¸²ã€æ•°å­—ç­‰å…¶ä»–ç±»å‹å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨`@Body`æ³¨è§£

```java
// ä¸Šä¼ æ–‡ä»¶çš„åŒæ—¶ï¼Œå¸¦ä¸Šå…¶ä»–ç±»å‹å‚æ•°
@Post(url = "/upload")
Map upload(@DataFile("file") File file, @Body("token") String token, @Body("num") Integer num);
```


### å¤šæ–‡ä»¶æ‰¹é‡ä¸Šä¼ 

```java

/**
 * ä¸Šä¼ MapåŒ…è£…çš„æ–‡ä»¶åˆ—è¡¨
 * å…¶ä¸­ ${_key} ä»£è¡¨Mapä¸­æ¯ä¸€æ¬¡è¿­ä»£ä¸­çš„é”®å€¼
 */
@PostRequest(url = "/upload")
ForestRequest<Map> uploadByteArrayMap(@DataFile(value = "file", fileName = "${_key}") Map<String, byte[]> byteArrayMap);

/**
 * ä¸Šä¼ ListåŒ…è£…çš„æ–‡ä»¶åˆ—è¡¨
 * å…¶ä¸­ ${_index} ä»£è¡¨æ¯æ¬¡è¿­ä»£Listçš„å¾ªç¯è®¡æ•°ï¼ˆä»é›¶å¼€å§‹è®¡ï¼‰
 */
@PostRequest(url = "/upload")
ForestRequest<Map> uploadByteArrayList(@DataFile(value = "file", fileName = "test-img-${_index}.jpg") List<byte[]> byteArrayList);

/**
 * ä¸Šä¼ æ•°ç»„åŒ…è£…çš„æ–‡ä»¶åˆ—è¡¨
 * å…¶ä¸­ ${_index} ä»£è¡¨æ¯æ¬¡è¿­ä»£Listçš„å¾ªç¯è®¡æ•°ï¼ˆä»é›¶å¼€å§‹è®¡ï¼‰
 */
@PostRequest(url = "/upload")
ForestRequest<Map> uploadByteArrayArray(@DataFile(value = "file", fileName = "test-img-${_index}.jpg") byte[][] byteArrayArray);
```

ä¸Šä¼ å¤šæ–‡ä»¶æ—¶ä¹Ÿå¯ä»¥å¸¦ä¸Šå…¶ä»–çš„å‚æ•°


```java
/**
 * ä¸Šä¼ MapåŒ…è£…çš„æ–‡ä»¶åˆ—è¡¨ï¼ŒåŒæ—¶å¸¦ä¸Šå…¶ä»–å‚æ•°
 */
@PostRequest(url = "/upload")
ForestRequest<Map> uploadByteArrayMap(@DataFile(value = "file", fileName = "${_key}") Map<String, byte[]> byteArrayMap, @Body("token") String token);
```


### äºŒè¿›åˆ¶ä¸Šä¼ 

å¯¹äº `application/octect-stream` ç­‰éform-dataçš„Content-Typeç±»å‹ï¼Œç›´æ¥ç”¨`@Body`ä¿®é¥°è¦ä¸Šä¼ çš„æ•°æ®å‚æ•°

```java
/**
 * ä¸Šä¼ Byteæ•°ç»„ç±»å‹æ•°æ®
 */
@Post(
        url = "/upload/${filename}",
        contentType = "application/octet-stream"
)
String uploadByteArryr(@Body byte[] body, @Var("filename") String filename);

/**
 * ä¸Šä¼ Fileç±»å‹æ•°æ®
 */
@Post(
    url = "/upload/${filename}",
    contentType = "application/octet-stream"
)
String uploadFile(@Body File file, @Var("filename") String filename);

/**
 * ä¸Šä¼ è¾“å…¥æµç±»å‹æ•°æ®
 */
@Post(
    url = "/upload/${filename}",
    contentType = "application/octet-stream"
)
String uploadInputStream(@Body InputStream inputStream, @Var("filename") String filename);

```


### ä¸‹è½½

```java
/**
 * åœ¨æ–¹æ³•ä¸ŠåŠ ä¸Š@DownloadFileæ³¨è§£
 * dirå±æ€§è¡¨ç¤ºæ–‡ä»¶ä¸‹è½½åˆ°å“ªä¸ªç›®å½•
 * filenameå±æ€§è¡¨ç¤ºæ–‡ä»¶ä¸‹è½½æˆåŠŸåä»¥ä»€ä¹ˆåå­—ä¿å­˜ï¼Œå¦‚æœä¸å¡«ï¼Œè¿™é»˜è®¤ä»URLä¸­å–å¾—æ–‡ä»¶å
 * OnProgresså‚æ•°ä¸ºç›‘å¬ä¸Šä¼ è¿›åº¦çš„å›è°ƒå‡½æ•°
 */
@Get(url = "http://localhost:8080/images/xxx.jpg")
@DownloadFile(dir = "${0}", filename = "${1}")
File downloadFile(String dir, String filename, OnProgress onProgress);
```


è°ƒç”¨ä¸‹è½½æ¥å£ä»¥åŠç›‘å¬ä¸Šä¼ è¿›åº¦çš„ä»£ç å¦‚ä¸‹ï¼š

```java
File file = myClient.downloadFile("D:\\TestDownload", progress -> {
    System.out.println("total bytes: " + progress.getTotalBytes());   // æ–‡ä»¶å¤§å°
    System.out.println("current bytes: " + progress.getCurrentBytes());   // å·²ä¸‹è½½å­—èŠ‚æ•°
    System.out.println("progress: " + Math.round(progress.getRate() * 100) + "%");  // å·²ä¸‹è½½ç™¾åˆ†æ¯”
    if (progress.isDone()) {   // æ˜¯å¦ä¸‹è½½å®Œæˆ
        System.out.println("--------   Download Completed!   --------");
    }
});
```

å¦‚æœæ‚¨ä¸æƒ³å°†æ–‡ä»¶ä¸‹è½½åˆ°ç¡¬ç›˜ä¸Šï¼Œè€Œæ˜¯ç›´æ¥åœ¨å†…å­˜ä¸­è¯»å–ï¼Œå¯ä»¥å»æ‰@DownloadFileæ³¨è§£ï¼Œå¹¶ä¸”ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼å®šä¹‰æ¥å£:

```java

/**
 * è¿”å›ç±»å‹ç”¨byte[]ï¼Œå¯å°†ä¸‹è½½çš„æ–‡ä»¶è½¬æ¢æˆå­—èŠ‚æ•°ç»„
 */
@GetRequest(url = "http://localhost:8080/images/test-img.jpg")
byte[] downloadImageToByteArray();

/**
 * è¿”å›ç±»å‹ç”¨InputStreamï¼Œç”¨æµçš„æ–¹å¼è¯»å–æ–‡ä»¶å†…å®¹
 */
@GetRequest(url = "http://localhost:8080/images/test-img.jpg")
InputStream downloadImageToInputStream();
```

ä»¥`InputStream`ç±»å‹æ¥å—çš„æ•°æ®åœ¨è¯»å–åä¸€å®šåˆ«å¿˜äº†<mark>å…³é—­æµ</mark>

```java
// ä½¿ç”¨ try-with-resource æœºåˆ¶è‡ªåŠ¨å…³é—­æµ
try (InputStream in = downloadImageToInputStream()) {
    String content = IOUtils.toString(in, StandardCharsets.UTF_8);
    ... ...
} catch(Exception ex) {
    ex.printStackTrace();
}

// æˆ–è€…è‡ªè¡Œå…³é—­æµ        
InputStream in = null;
try {
    in = downloadImageToInputStream();
    String content = IOUtils.toString(in, StandardCharsets.UTF_8);
    ... ...
} catch(Exception ex) {
    ex.printStackTrace();
} finally {
    if (in != null){
        in.close();
    }
}

```

:::warning æ³¨æ„
ç”¨<b>File</b>ç±»å‹å®šä¹‰çš„æ–‡ä»¶ä¸‹è½½æ¥å£æ–¹æ³•ï¼Œä¸€å®šè¦åŠ ä¸Š<b>@DownloadFile</b>æ³¨è§£
:::
