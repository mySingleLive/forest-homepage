---
id: sse_declarative
hide_title: true
title: ğŸ¿ å£°æ˜å¼ SSE æ¥å£
date: 2024-12-26 12:44:20
permalink: /pages/1.6.x/sse_declarative/
---

## SSE

SSEï¼ˆServer-Sent Eventsï¼‰ï¼Œä¹Ÿè¢«ç§°ä½œâ€œäº‹ä»¶æµâ€ï¼ˆEvent Streamï¼‰ï¼Œæ˜¯ä¸€ç§æ—¨åœ¨é€šè¿‡HTTPåè®®æ¥å®ç°æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„æŠ€æœ¯æ‰‹æ®µã€‚
å®ƒå¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´å»ºç«‹ä¸€æ¡æŒä¹…åŒ–çš„HTTPé•¿è¿æ¥ï¼Œå¹¶é€šè¿‡è¿™æ¡è¿æ¥å®ç°æœåŠ¡å™¨å‘å®¢æˆ·ç«¯çš„å®æ—¶æ•°æ®æ¨é€ï¼Œä½†å®¢æˆ·ç«¯ä¸èƒ½é€šè¿‡ SSE å‘æœåŠ¡ç«¯å‘é€æ•°æ®ã€‚

è‡ª`v1.6.0`ç‰ˆæœ¬èµ·ï¼ŒForest æä¾›äº†å¯¹ SSE çš„æ”¯æŒï¼Œå¹¶ä¸”æ”¯æŒ`å£°åå¼`å’Œ`ç¼–ç¨‹å¼`ä¸¤ç§ SSE è¯·æ±‚æ–¹å¼ã€‚

## å£°æ˜å¼ SSE æ¥å£

### æ¥å£å®šä¹‰

SSE çš„å£°åå¼æ¥å£å®šä¹‰æ–¹å¼å’Œæ™®é€š HTTP æ¥å£å®šä¹‰æ–¹å¼ç±»å‹ï¼Œåªéœ€è¦å°†`ForestSSE`ç±»ä½œä¸ºæ¥å£æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å³å¯ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åå³å¯è¿”å›`ForestSSE`ç±»çš„å¯¹è±¡å®ä¾‹ã€‚

`ForestSSE`æ˜¯ Forest çš„ SSE æ§åˆ¶å™¨ç±»ï¼Œé€šè¿‡æ­¤ç±»å¯¹è±¡å¯ä»¥è¿›è¡Œç›‘å¬ã€æ·»åŠ æ¶ˆæ¯å›è°ƒå‡½æ•°ç­‰æ“ä½œã€‚

```java
public interface SSEClient {
    
    // ForestSSE ä¸º Forest çš„ SSE æ§åˆ¶å™¨ç±»
    // åªè¦ä»¥æ­¤ç±»ä½œä¸ºæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œè¯¥æ–¹æ³•å°±è‡ªåŠ¨æˆä¸º SSE è¯·æ±‚æ–¹æ³•
    @Get(url = "/sse", contentType = "text/event-stream")
    ForestSSE testSSE();
}
```

### ç›‘å¬äº‹ä»¶

è°ƒç”¨æ¥å£æ–¹æ³•åä¼šè¿”å›`ForestSSE`ç±»å¯¹è±¡ï¼Œæ­¤æ—¶å˜åŒ–æŠŠæ™®é€šçš„ HTTP è¯·æ±‚è½¬æ¢ä¸º SSE æ§åˆ¶å™¨ï¼Œä½†ä¸ä¼šå‘é€ä»»ä½•å®é™…çš„ç½‘ç»œè¯·æ±‚ã€‚

```java
sseClient.testSSE(); // æŠŠæ™®é€šçš„ HTTP è¯·æ±‚è½¬æ¢ä¸º SSE æ§åˆ¶å™¨,ä½†ä¸ä¼šå‘é€ä»»ä½•å®é™…çš„ç½‘ç»œè¯·æ±‚
```

å¾—åˆ° SSE æ§åˆ¶å™¨ä¹‹åï¼Œä¾¿å¯è°ƒç”¨`listen()`æ–¹æ³•å¼€å§‹ç›‘å¬ SSE çš„äº‹ä»¶æµï¼Œå¹¶é˜»å¡å½“å‰è°ƒç”¨çš„çº¿ç¨‹ã€‚

```java
sseClient.testSSE().listen(); // å¼€å§‹ç›‘å¬ SSE äº‹ä»¶æµï¼Œå¹¶é˜»å¡å½“å‰çº¿ç¨‹
```

### å¼‚æ­¥ç›‘å¬

ForestSSE æ§åˆ¶å™¨ä¸­çš„`listen()`æ–¹æ³•æ˜¯ä¸€ç§åŒæ­¥çš„ç›‘å¬æ–¹æ³•ï¼Œå¦å¤– Forset ä¹Ÿæä¾›äº†å¼‚æ­¥çš„ç›‘å¬æ–¹æ³•ï¼š`asyncListen()`

```java
sseClient.testSSE().asyncListen(); // å¼€å§‹å¼‚æ­¥ç›‘å¬ SSE äº‹ä»¶æµï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹
```

ForestSSE ç±»è¿˜æä¾›äº†`await()`æ–¹æ³•ï¼Œç”¨äºé˜»å¡ç­‰å¾…å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å¼‚æ­¥ç›‘å¬ç»“æŸä¸ºæ­¢ã€‚

```java
ForestSSE sse = sseClient.testSSE().asyncListen(); // å¼€å§‹å¼‚æ­¥ç›‘å¬ SSE äº‹ä»¶æµ
sse.await(); // é˜»å¡å¹¶ç­‰å¾…å¼‚æ­¥ç›‘å¬ç»“æŸ
```


## äº‹ä»¶å¤„ç†

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`listen()`å’Œ`asyncListen()`æ–¹æ³•è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œä½†è‹¥åœ¨æ­¤æ—¶æ¥å—åˆ°å®é™…äº‹ä»¶æ¶ˆæ¯ï¼Œå¹¶ä¸ä¼šè¿›è¡Œä»»ä½•å¤„ç†ã€‚

å¦‚è¦é’ˆå¯¹ä¸åŒäº‹ä»¶å†…å®¹ï¼Œè¿›è¡Œå“åº”çš„å¤„ç†ï¼Œå°±éœ€è¦é€‰æ‹©ä¸€ç§äº‹ä»¶å¤„ç†æ–¹å¼æ¥å¤„ç†æ¥å—åˆ°çš„äº‹ä»¶ã€‚

åœ¨ Forest ä¸­äº‹ä»¶å¤„ç†çš„æ–¹å¼ä¹Ÿæœ‰ä¸‰ç§ï¼šSSE å›è°ƒå‡½æ•°ã€è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ã€ä»¥åŠ SSE æ‹¦æˆªå™¨ã€‚

### SSE å›è°ƒå‡½æ•°

SSE å›è°ƒå‡½æ•°æ¥å¤„ç†äº‹ä»¶çš„æ–¹å¼æœ€ä¸ºç®€ä¾¿å’Œç›´æ¥ï¼Œåœ¨è°ƒç”¨æ¥å£è¿”å› ForestSSE å¯¹è±¡åï¼Œå³å¯è°ƒç”¨å®ƒçš„`setOnOpen`ã€`setOnClose`ã€`addOnData`ã€`addOnEvent`
ç­‰æ–¹æ³•æ¥è®¾ç½®å¤„ç† SSE ä¸åŒç”Ÿå‘½å‘¨æœŸã€ä¸åŒç±»å‹äº‹ä»¶çš„å›è°ƒå‡½æ•°

```java
sseClient.testSSE() // è°ƒç”¨æ¥å£æ–¹æ³•åè¿”å› ForestSSE å¯¹è±¡
        .setOnOpen(eventSource -> {
            // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
            // eventSource ä¸º EventSource äº‹ä»¶æºå¯¹è±¡
            eventSource.request(); // è·å– Forest è¯·æ±‚å¯¹è±¡
            eventSource.response(); // è·å– Forest å“åº”å¯¹è±¡
        })
        .setOnClose(eventSource -> {
            // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
        })
        .addOnData((eventSource, name, value) -> {
            // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
            // name ä¸ºäº‹ä»¶æ¶ˆæ¯åç§° (åŒ eventSource.name())
            // value ä¸ºäº‹ä»¶æ¶ˆæ¯çš„å€¼
            eventSource.sse(); // è·å– SSE æ§åˆ¶å™¨
            eventSource.request(); // è·å– Forest è¯·æ±‚å¯¹è±¡
            eventSource.response(); // è·å– Forest å“åº”å¯¹è±¡
            eventSource.rawData(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„åŸå§‹æ•°æ®
            eventSource.name(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„åç§°ï¼Œå¦‚ dataã€eventã€id ç­‰
            eventSource.value(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œè¿”å›å­—ç¬¦ä¸²ç±»å‹æ•°æ®
            // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œå¹¶å°†æ¶ˆæ¯è½¬æ¢ä¸ºæŒ‡å®šçš„è‡ªå®šä¹‰ç±»å‹
            eventSource.value(MyUser.class);
            // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œå¹¶å°†æ¶ˆæ¯è½¬æ¢ä¸ºæŒ‡å®šçš„è‡ªå®šä¹‰æ³›å‹ç±»å‹
            eventSource.value(new TypeReference<List<MyUser>>() {});
        })
        .addOnEvent((eventSource, name, value) -> {
            // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º event çš„äº‹ä»¶
            // å‚æ•°å†…å®¹ä¸ä¸Šé¢çš„ addOnData å›è°ƒå‡½æ•°å‚æ•°ç›¸åŒ
        })
        .addOnId((eventSource, name, value) -> {
            // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º id çš„äº‹ä»¶
            // å‚æ•°å†…å®¹ä¸ä¸Šé¢çš„ addOnData æˆ– addOnEvent å›è°ƒå‡½æ•°å‚æ•°ç›¸åŒ
        })
        .addOnRetry((eventSource, name, value) -> {
            // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º retry çš„äº‹ä»¶
            // å‚æ•°å†…å®¹ä¸ä¸Šé¢çš„å‡ ä¸ªå›è°ƒå‡½æ•°å‚æ•°ç›¸åŒ
        })
        .listen(); // å¼€å§‹ç›‘å¬ SSE äº‹ä»¶æµ
```

`addOnData`ã€`addOnEvent`ä»¥åŠ`addOnId`ç­‰å‡½æ•°éƒ½æ˜¯ç›‘å¬å†…ç½®å›ºå®šæ¶ˆæ¯åç§°çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨`addConsumer`æ–¹æ³•æ¥å¤„ç†éå›ºå®šçš„ï¼Œé€šè¿‡å­—ç¬¦ä¸²å‚æ•°æŒ‡å®šçš„æ¶ˆæ¯åç§°çš„äº‹ä»¶

```java
sseClient.testSSE() // è°ƒç”¨æ¥å£æ–¹æ³•åè¿”å› ForestSSE å¯¹è±¡
        .addConsumer("data", (eventSource, name, value) -> {
            // é€šè¿‡å­—ç¬¦ä¸²å‚æ•°æŒ‡å®šè¦ç›‘å¬çš„æ¶ˆæ¯åç§°
            // ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ "data"ï¼Œå°±ä¼šç›‘å¬æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
            // å‚æ•°å†…å®¹ä¸ä¸Šé¢çš„ addOnDataã€addOnId ç­‰å›è°ƒå‡½æ•°å‚æ•°ä¸€è‡´
        })
        .addConsumer("event", (eventSource, name, value) -> {
            // é€šè¿‡å­—ç¬¦ä¸²å‚æ•°ï¼Œæ¥æŒ‡å®šè¦ç›‘å¬æ¶ˆæ¯åä¸º event çš„äº‹ä»¶
        })
        .addConsumer("push", (eventSource, name, value) -> {
            // å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šéæ ‡å‡†çš„æ¶ˆæ¯åç§°
        })
        .listen(); // å¼€å§‹ç›‘å¬ SSE äº‹ä»¶æµ
```

### è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨

å¦‚æœä¸æƒ³åœ¨è°ƒç”¨ SSE æ¥å£çš„åœ°æ–¹å†™ä¸€å¤§å † SSE äº‹ä»¶çš„å¤„ç†ä»£ç ï¼Œæƒ³æŠŠäº‹ä»¶ç›‘å¬å’Œæ¥å—åˆ°äº‹ä»¶åçš„äº‹ä»¶å¤„ç†é€»è¾‘ä»£ç è¿›è¡Œè§£è€¦ï¼Œç‹¬ç«‹åˆ°å¦ä¸€ä¸ªåœ°æ–¹çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ [è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨](/pages/1.6.x/sse_handler/#è‡ªå®šä¹‰-sse-æ§åˆ¶å™¨)

```java
// è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ç±»ï¼Œéœ€è¦ç»§æ‰¿ ForestSSE
public class MySSEHandler extends ForestSSE {
    
    @Override
    protected void onOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
        System.out.println("onOpen");
    }

    @Override
    protected void onClose(EventSource eventSource) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
        System.out.println("onClose");
    }

    @SSEDataMessage
    public void onSSEData(EventSource eventSource, @SSEName String name, @SSEValue String value) {
        // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
        System.out.println("onSSEData: " + name + ": " + value);
    }
}
```

ç„¶åå°†æ¥å£æ–¹æ³•ä¸­çš„è¿”å›ç±»å‹æ”¹æˆè‡ªå®šä¹‰çš„ SSE æ§åˆ¶å™¨ç±»å³å¯

```java
public interface SSEClient {
    
    // è¿”å›ç±»å‹æ”¹æˆè‡ªå®šä¹‰çš„ SSE æ§åˆ¶å™¨ç±»
    @Get(url = "/sse", contentType = "text/event-stream")
    MySSEHandler testSSE();
}
```

å®Œæˆè¿™ä¸€æ­¥åï¼Œåœ¨è°ƒç”¨æ—¶å°±æ— éœ€å†å†™å›è°ƒå‡½æ•°äº†

```java
// å¼€å§‹ç›‘å¬åï¼Œæ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ MySSEHandler ä¸­çš„äº‹ä»¶å¤„ç†æ–¹æ³•
sseClient.testSSE().listen();
```

å…³äºå…·ä½“å¦‚ä½•å®ç°è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ï¼Œè¯·å‚è§ã€Š[è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨](/pages/1.6.x/sse_handler/#è‡ªå®šä¹‰-sse-æ§åˆ¶å™¨)ã€‹

### SSE æ‹¦æˆªå™¨

é™¤äº†å›è°ƒå‡½æ•°å’Œè‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ä¸¤ç§æ–¹å¼å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ [SSE æ‹¦æˆªå™¨](/pages/1.6.x/sse_interceptor/)æ¥å®ç° SSE äº‹ä»¶çš„å¤„ç†

ç›¸æ¯”äº SSE æ§åˆ¶å™¨ï¼ŒSSE æ‹¦æˆªå™¨ä¸ºå•ä¾‹å¯¹è±¡ï¼Œä¸ä¼šåœ¨æ¯æ¬¡å‘èµ· SSE è¯·æ±‚æ—¶åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”å¯ä»¥æ³¨å…¥åˆ° Spring ä¸Šä¸‹æ–‡ä¸­ï¼Œå¯è°ƒç”¨ Spring ä¸Šä¸‹æ–‡ä¸­çš„å¯¹è±¡å’Œèµ„æº

```java
// è‡ªå®šä¹‰ SSE æ‹¦æˆªå™¨
// ä¸€å®šè¦åŠ ä¸Š @Component æ³¨è§£ï¼Œä¸åŠ ä¸Šå°±ä¸èƒ½æ³¨å…¥åˆ° Spring ä¸Šä¸‹æ–‡
@Component
public class MySSEInterceptor implements SSEInterceptor {
    
    // å¯ä»¥æ³¨å…¥ Spring ä¸Šä¸‹æ–‡ä¸­çš„å¯¹è±¡
    @Resource
    private MyUserService myUserService;

    @Override
    protected void onOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
        System.out.println("onOpen");
    }

    @Override
    protected void onClose(EventSource eventSource) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
        System.out.println("onClose");
    }

    @SSEDataMessage
    public void onSSEData(EventSource eventSource, @SSEName String name, @SSEValue String value) {
        // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
        System.out.println("onSSEData: " + name + ": " + value);
        myUserService.send(value);
    }
}
```

å®šä¹‰å®Œ SSE æ‹¦æˆªå™¨ä¹‹åï¼Œåªè¦åƒæ™®é€šæ‹¦æˆªå™¨é‚£æ ·ç»‘å®šåˆ°æ¥å£æ–¹æ³•ä¸Šæ¥å£

```java
public interface SSEClient {
    
    // å°†è‡ªå®šä¹‰ SSE æ‹¦æˆªå™¨ç»‘å®šåˆ°è¯¥æ¥å£æ–¹æ³•ä¸Š
    // è¿”å›ç±»å‹ä»ç„¶ä¸º ForestSSE
    @Get(
        url = "/sse",
        contentType = "text/event-stream",
        interceptor = MySSEInterceptor.class
    )
    ForestSSE testSSE();
}
```

å®Œæˆè¿™ä¸€æ­¥åï¼Œåœ¨è°ƒç”¨æ—¶å°±æ— éœ€å†å†™å›è°ƒå‡½æ•°äº†

```java
// å¼€å§‹ç›‘å¬åï¼Œæ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ MySSEInterceptor æ‹¦æˆªå™¨ä¸­çš„äº‹ä»¶å¤„ç†æ–¹æ³•
sseClient.testSSE().listen();
```

å…³äº SSE æ‹¦æˆªå™¨çš„è¯¦æƒ…ï¼Œè¯·å‚è§ã€Š[SSE æ‹¦æˆªå™¨](/pages/1.6.x/sse_interceptor/)ã€‹

## å…³é—­ SSE äº‹ä»¶æµ

å¯ä»¥è°ƒç”¨ SSE æ§åˆ¶å™¨åŠå…¶å­ç±»(ä¹Ÿå°±æ˜¯è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ç±»)çš„`close()`æ–¹æ³•

ä½¿ç”¨æ­¤æ–¹æ³•éœ€è¦å…ˆè·å¾— SSE æ§åˆ¶å™¨å¯¹è±¡

```java
// é€šè¿‡å¼‚æ­¥ç›‘å¬è·å¾— SSE æ§åˆ¶å™¨å¯¹è±¡
ForestSSE sse = sseClient.testSSE().asyncListen();
```

æˆ–æ˜¯å…ˆè·å¾— SSE æ§åˆ¶å™¨ï¼Œå†è¿›è¡ŒåŒæ­¥ç›‘å¬

```java
// å…ˆè·å¾— SSE æ§åˆ¶å™¨å¯¹è±¡
ForestSSE sse = sseClient.testSSE();
// å†è¿›è¡ŒåŒæ­¥ç›‘å¬
sse.listen();
```

ä¹Ÿå¯ä»¥é€šè¿‡`EventSource`å¯¹è±¡è·å¾— SSE æ§åˆ¶å™¨

```java
ForestSSE sse;

sseClient.testSSE()
        .setOnOpen(eventSource -> {
            // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
            sse = eventSource.sse();
        });
```

åœ¨è·å¾—åˆ° SSE æ§åˆ¶å™¨ä¹‹åå³å¯è°ƒç”¨`close()`æ–¹æ³•å…³é—­ SSE äº‹ä»¶æµ

```java
sse.close(); // æ‰‹åŠ¨å…³é—­äº‹ä»¶æµï¼Œåœæ­¢ SSE ç›‘å¬
```

ç¬¬äºŒç§æ–¹æ³•æ˜¯ï¼Œè°ƒç”¨`EventSource`å¯¹è±¡çš„`close()`æ–¹æ³•ï¼Œæ•ˆæœç›¸åŒ

```java
sseClient.testSSE()
        .addOnData((eventSource, name, value) -> {
            // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
            if ("close".equals(value)) {
                eventSource.close(); // æ‰‹åŠ¨å…³é—­äº‹ä»¶æµï¼Œåœæ­¢ SSE ç›‘å¬
            }
        })
        .listen();
```