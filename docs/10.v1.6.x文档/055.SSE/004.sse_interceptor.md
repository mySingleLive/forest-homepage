---
id: sse_declarative
hide_title: true
title: ğŸ¬ SSE æ‹¦æˆªå™¨
date: 2024-12-26 12:44:20
permalink: /pages/1.6.x/sse_interceptor/
---

## SSE æ‹¦æˆªå™¨

SSE æ‹¦æˆªå™¨ä¹Ÿæ˜¯æ™®é€šæ‹¦æˆªå™¨çš„ä¸€ç§ï¼Œå®ç°è‡ªå®šä¹‰çš„ SSE æ‹¦æˆªå™¨éœ€è¦å®ç°`com.dtflys.forest.interceptor.SSEInterceptor`æ¥å£ã€‚

å¦‚æœè¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨å’Œ`Interceptor`æ¥å£ï¼Œå¯ä»¥å…ˆå‚è§ã€Š[æ‹¦æˆªå™¨](/pages/1.6.x/interceptor/)ã€‹ã€‚

ç›¸æ¯”äºè‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ï¼ŒSSE æ‹¦æˆªå™¨åŒæ ·å¯ä»¥æ§åˆ¶ SSE äº‹ä»¶æµçš„å„ä¸ªç”Ÿå‘½å‘¨æœŸã€ä»¥åŠå¤„ç†æ‰€æœ‰äº‹ä»¶æ¶ˆæ¯ï¼Œå”¯ä¸€æœ‰æ‰€ä¸åŒçš„æ˜¯ï¼ŒSSE æ‹¦æˆªå™¨æ˜¯`å•ä¾‹`ï¼Œä¸ä¼šåƒ SSE æ§åˆ¶å™¨é‚£æ ·æ¯å‘èµ·ä¸€æ¬¡ SSE è¯·æ±‚éƒ½ä¼šå®ä¾‹åŒ–ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œä¸€ä¸ª SSE æ‹¦æˆªå™¨ç±»æ°¸è¿œéƒ½åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚

```java
// è‡ªå®šä¹‰ SSE æ‹¦æˆªå™¨ï¼Œéœ€å®ç° SSEInterceptor æ¥å£
public class MySSEInterceptor implements SSEInterceptor {
    
    // onSuccess æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    public void onSuccess(InputStream data, ForestRequest request, ForestResponse response) {
        // å’Œæ™®é€šæ‹¦æˆªå™¨ onSuccess ç›¸åŒï¼Œdata æ˜¯ SSE çš„æ¶ˆæ¯æµï¼Œä¸å»ºè®®åœ¨è¿™é‡ŒåŠ¨å®ƒ
    }

    // afterExecute æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    public void afterExecute(ForestRequest request, ForestResponse response) {
        // å’Œæ™®é€šæ‹¦æˆªå™¨ afterExecute ç›¸åŒ
    }

    // onSSEOpen æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    public void onSSEOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
    }

    // onSSEClose æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    public void onSSEClose(ForestRequest request, ForestResponse response) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
    }
}
```

ç”±ä¸Šé¢ä»£ç å¯è§ï¼ŒSSE æ‹¦æˆªå™¨ä¹Ÿæ˜¯æ™®é€šæ‹¦æˆªå™¨æ¥å£`Interceptor`çš„å®ç°ç±»ï¼Œè€Œç›¸æ¯”äºæ™®é€šæ‹¦æˆªå™¨è€Œè¨€ï¼ŒSSE æ‹¦æˆªå™¨å¤šäº†`onSSEOpen`å’Œ`onSSEClose`æ–¹æ³•å¯é‡å†™ï¼Œåˆ†åˆ«ç”¨äºåœ¨ SSE å¼€å§‹ç›‘å¬å’Œç»“æŸç›‘å¬æ—¶è°ƒç”¨ã€‚

æ­¤å¤–ï¼Œå’Œè‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ä¸€æ ·ï¼Œå¯ä»¥åœ¨ SSE æ‹¦æˆªå™¨ä¸­ä¹Ÿå¯ä»¥å£°æ˜å’Œå®šä¹‰ SSE äº‹ä»¶å¤„ç†æ–¹æ³•

```java
// è‡ªå®šä¹‰ SSE æ‹¦æˆªå™¨ï¼Œéœ€å®ç° SSEInterceptor æ¥å£
public class MySSEInterceptor implements SSEInterceptor {
    
    // onSSEOpen æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    public void onSSEOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
    }

    // onSSEClose æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    public void onSSEClose(ForestRequest request, ForestResponse response) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
    }

    @SSEDataMessage
    public void onSSEData(EventSource eventSource, @SSEName String name, @SSEValue String value) {
        // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
        // å£°æ˜çš„æ–¹æ³•åå’Œå¤„ç†çš„äº‹ä»¶æ¶ˆæ¯åç§°æ²¡æœ‰å…³ç³»ï¼Œæ–¹æ³•åå¯ä»¥æ˜¯ onDataã€onSseDataã€onMessageã€xxxã€ä»¥åŠä»»ä½•åç§°éƒ½å¯ä»¥
        // @SSEName æ³¨è§£ä¿®é¥°çš„å‚æ•° name ä¸ºäº‹ä»¶æ¶ˆæ¯åç§° (åŒ eventSource.name())
        // @SSEValue æ³¨è§£ä¿®é¥°çš„å‚æ•° value ä¸ºäº‹ä»¶æ¶ˆæ¯çš„å€¼
        eventSource.sse(); // è·å– SSE æ§åˆ¶å™¨
        eventSource.request(); // è·å– Forest è¯·æ±‚å¯¹è±¡
        eventSource.response(); // è·å– Forest å“åº”å¯¹è±¡
        eventSource.rawData(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„åŸå§‹æ•°æ®
        eventSource.name(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„åç§°ï¼Œå¦‚ dataã€eventã€id ç­‰
        eventSource.value(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œè¿”å›å­—ç¬¦ä¸²ç±»å‹æ•°æ®
        // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œå¹¶å°†æ¶ˆæ¯è½¬æ¢ä¸ºæŒ‡å®šçš„è‡ªå®šä¹‰ç±»å‹
        eventSource.value(MyUser.class);
        // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œå¹¶å°†æ¶ˆæ¯è½¬æ¢ä¸ºæŒ‡å®šçš„è‡ªå®šä¹‰æ³›å‹ç±»å‹
        eventSource.value(new TypeReference<List<MyUser>>() {});
    }
}
```

å…³äºå…·ä½“å¦‚ä½•å£°æ˜å’Œå®šä¹‰ SSE äº‹ä»¶æ¶ˆæ¯çš„å¤„ç†æ–¹æ³•ï¼Œè¯·å‚è§ã€Š[SSEäº‹ä»¶å¤„ç†æ–¹æ³•](/pages/1.6.x/sse_method/)ã€‹

## SSE æ‹¦æˆªå™¨ä¸ Spring é›†æˆ

[SSE æ§åˆ¶å™¨](/pages/1.6.x/sse_handler/)å’Œ[è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨](/pages/1.6.x/sse_handler/#è‡ªå®šä¹‰-sse-æ§åˆ¶å™¨)éƒ½æ˜¯éå•ä¾‹çš„ç‹¬ç«‹å®ä¾‹å¯¹è±¡ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥æ³¨å…¥å’Œä½¿ç”¨ spring ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºã€‚

è€Œ SSE æ‹¦æˆªå™¨æ¥å£`SSEInterceptor`ç»§æ‰¿è‡ª`Interceptor`ï¼Œå¯ä»¥æ³¨å…¥åˆ° spring ä¸Šä¸‹æ–‡ä¸­å¹¶ä½¿ç”¨å…¶ä¸­çš„ beanï¼Œä½†å’Œæ™®é€šæ‹¦æˆªå™¨ä¸€æ ·ï¼Œä¸€å®šè¦åŠ ä¸Š`@Component`æ³¨è§£ï¼Œæˆ–è€…ç¡®ä¿å®ƒä¸€å®šè¢« Spring æ‰«æå™¨æ‰«æåˆ°

```java
// è¦æ³¨å…¥ Spring ä¸Šä¸‹æ–‡çš„ï¼Œä¸€å®šè¦åŠ ä¸Š @Component æ³¨è§£ï¼Œä¸åŠ ä¸Šå°±ä¸èƒ½æ³¨å…¥åˆ° Spring ä¸Šä¸‹æ–‡
@Component
public class MySSEInterceptor implements SSEInterceptor {
    
    // å¯ä»¥æ³¨å…¥ Spring ä¸Šä¸‹æ–‡ä¸­çš„å¯¹è±¡
    @Resource
    private MyUserService myUserService;

}
```

## åœ¨ SSE æ‹¦æˆªå™¨ä¸­ä¼ é€’æ•°æ®
:::warning æ³¨æ„
ä¸èƒ½ä½¿ç”¨å…±äº«å˜é‡

ç”±äº SSE æ‹¦æˆªå™¨æ˜¯å•ä¾‹ï¼Œæ‰€ä»¥ä¸èƒ½åƒ SSE æ§åˆ¶å™¨é‚£æ ·ä½¿ç”¨å…±äº«å˜é‡çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®

è€Œåº”è¯¥åƒæ™®é€šæ‹¦æˆªå™¨é‚£æ ·ä½¿ç”¨`Attribute`æˆ–`Attachment`

è¯¦æƒ…è¯·å‚è§ã€Š[åœ¨æ‹¦æˆªå™¨ä¸­ä¼ é€’æ•°æ®](/pages/1.6.x/interceptor/#åœ¨æ‹¦æˆªå™¨ä¸­ä¼ é€’æ•°æ®)ã€‹
:::

ä½¿ç”¨`Attribute`æˆ–`Attachment`æ¥å®ç°è·¨ç”Ÿå‘½å‘¨æœŸã€è·¨äº‹ä»¶æ¶ˆæ¯çš„æ•°æ®ä¼ é€’

```java
// è‡ªå®šä¹‰ SSE æ‹¦æˆªå™¨ï¼Œéœ€å®ç° SSEInterceptor æ¥å£
public class MySSEInterceptor implements SSEInterceptor {

    @Override
    public void onSuccess(InputStream data, ForestRequest request, ForestResponse response) {
        // è¯·æ±‚å‘é€æˆåŠŸæ˜¯è°ƒç”¨
        // åˆ›å»ºæˆ–è·å–åä¸º text çš„ Attachmentï¼Œç±»å‹ä¸º StringBuilder
        StringBuilder builder = (StringBuilder) request.getOrAddAttachment("text", StringBuilder::new);
        builder.append("onSuccess\n");
    }

    @Override
    public void afterExecute(ForestRequest request, ForestResponse response) {
        // è¯·æ±‚æ‰§è¡Œå®Œæˆåè°ƒç”¨
        // åˆ›å»ºæˆ–è·å–åä¸º text çš„ Attachmentï¼Œç±»å‹ä¸º StringBuilder
        StringBuilder builder = (StringBuilder) request.getOrAddAttachment("text", StringBuilder::new);
        builder.append("afterExecute\n");
    }

    @SSEDataMessage
    public void onData(ForestRequest request, @SSEName String name, @SSEValue String value) {
        // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶ 
        // åˆ›å»ºæˆ–è·å–åä¸º text çš„ Attachmentï¼Œç±»å‹ä¸º StringBuilder
        StringBuilder builder = (StringBuilder) request.getOrAddAttachment("text", StringBuilder::new);
        builder.append("Receive name=" + name + "; value=" + value + "\n");
    }
}

```