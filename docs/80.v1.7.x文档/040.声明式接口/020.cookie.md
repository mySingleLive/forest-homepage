---
id: cookie
title: ğŸª ä½¿ç”¨Cookie
date: 2022-07-01 12:44:20
permalink: /pages/1.7.x/cookie/
---


Cookieæ˜¯ç”±æœåŠ¡å™¨ç«¯ç”Ÿæˆï¼Œå‘é€ç»™å®¢æˆ·ç«¯ï¼ˆä¸€èˆ¬ä¸ºæµè§ˆå™¨ï¼‰ï¼Œå¹¶ä»¥key-valueå½¢å¼å¤„ç†å’Œä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ä¸€ç»„æ•°æ®ã€‚åœ¨ä¸‹æ¬¡è¯·æ±‚åŒä¸€åŸŸåç½‘ç«™æ—¶ï¼Œä¼šå°†è¯¥Cookieæ•°æ®å†æ¬¡å‘é€åˆ°æœåŠ¡ç«¯ã€‚

Forestä»`1.5.0-RC1`ç‰ˆæœ¬å¼€å§‹æ”¯æŒCookieï¼Œå¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°å’Œæ‹¦æˆªå™¨ä¸¤ç§æ–¹å¼æ¥å¤„ç†Cookieã€‚

## å›è°ƒå‡½æ•°æ–¹å¼

åœ¨è¯·æ±‚æ¥å£çš„å‚æ•°åˆ—è¡¨ä¸­åŠ å…¥`OnSaveCookie` å’Œ `OnLoadCookie` å›è°ƒå‡½æ•°

`OnSaveCookie`ï¼š åœ¨è¯·æ±‚å“åº”æˆåŠŸåï¼Œéœ€è¦ä¿å­˜Cookieæ—¶è°ƒç”¨è¯¥å›è°ƒå‡½æ•°

`OnLoadCookie`: åœ¨å‘é€è¯·æ±‚å‰ï¼Œéœ€è¦åŠ è½½Cookieæ—¶è°ƒç”¨è¯¥å›è°ƒå‡½æ•°

````java

/**
 * ç™»å…¥æ¥å£(éœ€è¦æ¥å—Cookie)
 */
@Post("http://localhost:8080/login?username=foo")
ForestResponse testLogin(@Body UserLoginDTO userLogin, OnSaveCookie onSaveCookie);

/**
 * ç™»å…¥åæµ‹è¯•æ¥å£(éœ€è¦ä¼ å…¥Cookie)
 */
@Post("http://localhost:8080/test")
ForestResponse testAfterLogin(OnLoadCookie onLoadCookie);

````

Forest<b>ä¸ä¼š</b>è‡ªåŠ¨å¤„ç†æˆ–æŒä¹…åŒ–æœåŠ¡ç«¯ä¼ æ¥çš„Cookieæ•°æ®ï¼Œéœ€è¦è‡ªå·±åœ¨å›è°ƒå‡½æ•°ä¸­æ¥åˆ°Cookieåè‡ªè¡Œå¤„ç†ã€‚

```java

AtomicReference<ForestCookie> cookieAtomic = new AtomicReference<>(null);

// è°ƒç”¨ç™»å…¥æ¥å£
testClient.testLogin(userLogin, (request, cookies) -> {
    // å°†æœåŠ¡ç«¯ä¼ æ¥çš„Cookieæ”¾å…¥cookieAtomic
    cookieAtomic.set(cookies.allCookies().get(0));
});

// è·å–Cookie
ForestCookie cookie = cookieAtomic.get();

// è°ƒç”¨ç™»å…¥åçš„æµ‹è¯•æ¥å£
ForestResponse response = testClient.testAfterLogin((request, cookies) -> {
    // å°†ä¹‹å‰è°ƒç”¨ç™»å…¥æ¥å£è·å¾—çš„Cookieä¼ å…¥è¯·æ±‚å‘é€åˆ°æœåŠ¡ç«¯
    cookies.addCookie(cookie);
});

```

## æ‹¦æˆªå™¨æ–¹å¼

æ‹¦æˆªå™¨æ–¹å¼åŸç†ä¸Šå’Œå›è°ƒå‡½æ•°æ–¹å¼ä¸€æ ·ï¼Œåªä¸è¿‡`OnSaveCookie` å’Œ `OnLoadCookie` å›è°ƒå‡½æ•°æ¥å£å˜æˆäº†æ‹¦æˆªå™¨ä¸­çš„ `onSaveCookie(ForestRequest, ForestCookies)` æ–¹æ³•å’Œ `onLoadCookie(ForestRequest, ForestCookies)` æ–¹æ³•ã€‚

```java
/**
 * å¤„ç†Cookieçš„æ‹¦æˆªå™¨
 */
public class CookieInterceptor implements Interceptor {
    
    // Cookieåœ¨æœ¬åœ°å­˜å‚¨çš„ç¼“å­˜
    private Map<String, List<ForestCookie>> cookieCache = new ConcurrentHashMap<>();

    /**
     * åœ¨è¯·æ±‚å“åº”æˆåŠŸåï¼Œéœ€è¦ä¿å­˜Cookieæ—¶è°ƒç”¨è¯¥æ–¹æ³•
     *
     * @param request Forestè¯·æ±‚å¯¹è±¡
     * @param cookies Cookieé›†åˆï¼Œé€šè¿‡å“åº”è¿”å›çš„Cookieéƒ½ä»è¯¥é›†åˆè·å–
     */
    @Override
    public void onSaveCookie(ForestRequest request, ForestCookies cookies) {
        // è·å–è¯·æ±‚URIçš„ä¸»æœºå
        String host = request.getURI().getHost();
        // å°†ä»æœåŠ¡ç«¯è·å¾—çš„Cookieåˆ—è¡¨æ”¾å…¥ç¼“å­˜ï¼Œä¸»æœºåä½œä¸ºKey
        cookieCache.put(host, cookies.allCookies());
    }

    /**
     * åœ¨å‘é€è¯·æ±‚å‰ï¼Œéœ€è¦åŠ è½½Cookieæ—¶è°ƒç”¨è¯¥æ–¹æ³•
     *
     * @param request Forestè¯·æ±‚å¯¹è±¡
     * @param cookies Cookieé›†åˆ, éœ€è¦é€šè¿‡è¯·æ±‚å‘é€çš„Cookieéƒ½æ·»åŠ åˆ°è¯¥é›†åˆ
     */
    @Override
    public void onLoadCookie(ForestRequest request, ForestCookies cookies) {
        // è·å–è¯·æ±‚URIçš„ä¸»æœºå
        String host = request.getURI().getHost();
        // ä»ç¼“å­˜ä¸­è·å–ä¹‹å‰è·å¾—çš„Cookieåˆ—è¡¨ï¼Œä¸»æœºåä½œä¸ºKey
        List<ForestCookie> cookieList = cookieCache.get(host);
        // å°†ç¼“å­˜ä¸­çš„Cookieåˆ—è¡¨æ·»åŠ åˆ°è¯·æ±‚Cookieåˆ—è¡¨ä¸­ï¼Œå‡†å¤‡å‘é€åˆ°æœåŠ¡ç«¯
        // é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶ (å’Œè¯·æ±‚åŒåŸŸåã€åŒURLè·¯å¾„ã€æœªè¿‡æœŸ) çš„ Cookie æ‰èƒ½è¢«æ·»åŠ åˆ°è¯·æ±‚ä¸­
        cookies.addAllCookies(cookieList);
    }

    @Override
    public void onError(ForestRuntimeException ex, ForestRequest request, ForestResponse response) {
        // ... ...
    }

    @Override
    public void onSuccess(Object data, ForestRequest request, ForestResponse response) {
        // ... ...
    }
}
```


## ä¸¥æ ¼åŒ¹é…æ¨¡å¼ (v1.5.25)

é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶ (å’Œè¯·æ±‚åŒåŸŸåã€åŒURLè·¯å¾„ã€æœªè¿‡æœŸ) çš„ Cookie æ‰èƒ½è¢«æ·»åŠ åˆ°è¯·æ±‚ä¸­

è¿™æ˜¯å› ä¸º Forest çš„ Cookie é›†åˆé»˜è®¤ä¸ºä¸¥æ ¼åŒ¹é…æ¨¡å¼ï¼Œå¦‚æœæƒ³æ·»åŠ ç¬¦åˆåŒ¹é…è¦æ±‚çš„ Cookieï¼Œåªéœ€ä¿®æ”¹ä¸¥æ ¼åŒ¹é…ä¸º`false`å³å¯


```java
@Override
public void onLoadCookie(ForestRequest request, ForestCookies cookies) {
    cookies.strict(false) // è®¾ç½®ä¸ºéä¸¥æ ¼åŒ¹é…æ¨¡å¼
        .addCookie(new ForestCookie("attr1", "foo")) // ä¸è®¾åŸŸåï¼Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿèƒ½æ·»åŠ 
        .addCookie(new ForestCookie("attr2", "bar")) // ä¸è®¾åŸŸåï¼Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿèƒ½æ·»åŠ 
        // ä¸è®¾åŸŸåï¼Œåªæœ‰åœ¨éä¸¥æ ¼åŒ¹é…æ¨¡å¼ä¸‹å¯ä»¥æ·»åŠ åˆ°è¯·æ±‚ä¸­
        .addCookie(new ForestCookie("attr3", "foobar").setDomain("xxx.com"));
}
```
