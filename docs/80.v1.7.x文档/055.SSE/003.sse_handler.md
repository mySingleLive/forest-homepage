---
id: sse_declarative
hide_title: true
title: ğŸ¶ SSE æ§åˆ¶å™¨
date: 2024-12-26 12:44:20
permalink: /pages/1.7.x/sse_handler/
---

## SSE æ§åˆ¶å™¨

SSE æ§åˆ¶å™¨ï¼Œå³`ForestSSE`å¯¹è±¡å®ä¾‹ï¼Œæ˜¯ç”¨äºå‘èµ·è¯·æ±‚ã€å»ºç«‹è¿æ¥ã€è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œä»¥åŠç»´æŒæ•´ä¸ª SSE äº‹ä»¶æµç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ã€‚å¯ä»¥æŠŠä¸€ä¸ª SSE æ§åˆ¶å™¨å¯¹è±¡ç†è§£ä¸ºä¸€ä¸ª SSE äº‹ä»¶æµçš„ä¼šè¯ã€‚

ä¸€ä¸ª SSE äº‹ä»¶æµå°±æœ‰ä¸€ä¸ªå¯¹åº”çš„ SSE æ§åˆ¶å™¨ï¼Œå¤šä¸ªä¸åŒ SSE è¯·æ±‚å°±æœ‰å¤šä¸ªå¯¹åº”çš„ SSE æ§åˆ¶å™¨ï¼Œå®ƒä»¬ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ã€‚

è·å– SSE æ§åˆ¶å™¨çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥é€šè¿‡å£°åå¼æ¥å£è¿”å›`ForestSSE`å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç¼–ç¨‹å¼æ¥å£ä¸­`ForestRequest`è¯·æ±‚å¯¹è±¡çš„`sse()`æ–¹æ³•è¿”å›å¾—åˆ°`ForestSSE`å¯¹è±¡ã€‚

å…³äºå¦‚ä½•å…·ä½“è·å¾— SSE æ§åˆ¶å™¨ã€ä»¥åŠä»¶ç›‘å¬å’Œå…³é—­ï¼Œè¯·å‚è§ã€Š[å£°æ˜å¼ SSE æ¥å£](/pages/1.7.x/sse_declarative/)ã€‹æˆ– ã€Š[ç¼–ç¨‹å¼ SSE æ¥å£](/pages/1.7.x/sse_api/)ã€‹

## è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨

è‡ªå®šä¹‰ä¸€ä¸ª SSE æ§åˆ¶å™¨éœ€è¦ç»§æ‰¿`com.dtflys.forest.http.ForestSSE`ç±»ï¼Œå¹¶ä¸”å¯ä»¥é‡å†™å…¶ä¸­çš„`onOpen`æ–¹æ³•å’Œ`onClose`æ–¹æ³•ï¼Œç”¨äºå®ç° SSE å¼€å§‹ç›‘å¬å’Œç»“æŸç›‘å¬æ—¶çš„å¤„ç†ä»£ç 

è€Œé€šè¿‡é‡å†™`onMessage`æ–¹æ³•ï¼Œå¯ä»¥å¤„ç† SSE æ¶ˆæ¯

```java
// è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ç±»ï¼Œéœ€è¦ç»§æ‰¿ ForestSSE
public class MySSEHandler extends ForestSSE {
    
    // opOpen æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    protected void onOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
        // eventSource ä¸º EventSource äº‹ä»¶æºå¯¹è±¡
        eventSource.getRequest(); // è·å– Forest è¯·æ±‚å¯¹è±¡
        eventSource.getResponse(); // è·å– Forest å“åº”å¯¹è±¡
    }

    // onClose æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    protected void onClose(EventSource eventSource) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
    }

    // 1.6.4+ ç‰ˆæœ¬å¯ä»¥é‡å†™ onMessage æ–¹æ³•æ¥æ¥æ”¶ SSE æ¶ˆæ¯
    @Override
    public void onMessage(EventSource event) {
        event.id(); // è·å–æ¶ˆæ¯åç§°ä¸º id çš„æ¶ˆæ¯å€¼
        event.event(); // è·å–æ¶ˆæ¯åç§°ä¸º event çš„æ¶ˆæ¯å€¼
        event.data(); // è·å–æ¶ˆæ¯åç§°ä¸º data çš„æ¶ˆæ¯å€¼
        event.retry(); // è·å–æ¶ˆæ¯åç§°ä¸º retry çš„æ¶ˆæ¯å€¼
        event.value("text"); // è·å–éæ ‡å‡†æ¶ˆæ¯åç§°ä¸º text çš„æ¶ˆæ¯å€¼
    }

}

```


## SSE äº‹ä»¶å¤„ç†æ–¹æ³•

ç„¶åå°±å¯ä»¥åœ¨è‡ªå®šä¹‰çš„ SSE æ§åˆ¶å™¨ç±»ä¸­å£°æ˜å’Œå®šä¹‰ SSE äº‹ä»¶å¤„ç†æ–¹æ³•äº†

```java
// è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ç±»ï¼Œéœ€è¦ç»§æ‰¿ ForestSSE
public class MySSEHandler extends ForestSSE {
    
    // opOpen æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    protected void onOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
        // eventSource ä¸º EventSource äº‹ä»¶æºå¯¹è±¡
        eventSource.getRequest(); // è·å– Forest è¯·æ±‚å¯¹è±¡
        eventSource.getResponse(); // è·å– Forest å“åº”å¯¹è±¡
    }

    // onClose æ–¹æ³•å¯é‡å†™ï¼Œå¯ä¸é‡å†™
    @Override
    protected void onClose(EventSource eventSource) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
    }

    // 1.6.4+ ç‰ˆæœ¬å¯ä»¥é‡å†™ onMessage æ–¹æ³•æ¥æ¥æ”¶ SSE æ¶ˆæ¯
    @Override
    public void onMessage(EventSource event) {
        event.id(); // è·å–æ¶ˆæ¯åç§°ä¸º id çš„æ¶ˆæ¯å€¼
        event.event(); // è·å–æ¶ˆæ¯åç§°ä¸º event çš„æ¶ˆæ¯å€¼
        event.data(); // è·å–æ¶ˆæ¯åç§°ä¸º data çš„æ¶ˆæ¯å€¼
        event.retry(); // è·å–æ¶ˆæ¯åç§°ä¸º retry çš„æ¶ˆæ¯å€¼
        event.value("text"); // è·å–éæ ‡å‡†æ¶ˆæ¯åç§°ä¸º text çš„æ¶ˆæ¯å€¼
    }
    
    // åªå¤„ç†æ¶ˆæ¯åä¸º data çš„äº‹ä»¶
    @SSEDataMessage
    public void onSSEData(EventSource eventSource, @SSEName String name, @SSEValue String value) {
        // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
        // å£°æ˜çš„æ–¹æ³•åå’Œå¤„ç†çš„äº‹ä»¶æ¶ˆæ¯åç§°æ²¡æœ‰å…³ç³»ï¼Œæ–¹æ³•åå¯ä»¥æ˜¯ onDataã€onSseDataã€onMessageã€xxxã€ä»¥åŠä»»ä½•åç§°éƒ½å¯ä»¥
        // @SSEName æ³¨è§£ä¿®é¥°çš„å‚æ•° name ä¸ºäº‹ä»¶æ¶ˆæ¯åç§° (åŒ eventSource.name())
        // @SSEValue æ³¨è§£ä¿®é¥°çš„å‚æ•° value ä¸ºäº‹ä»¶æ¶ˆæ¯çš„å€¼
        eventSource.sse(); // è·å– SSE æ§åˆ¶å™¨
        eventSource.request(); // è·å– Forest è¯·æ±‚å¯¹è±¡
        eventSource.response(); // è·å– Forest å“åº”å¯¹è±¡
        eventSource.rawData(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„åŸå§‹æ•°æ®
        eventSource.name(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„åç§°ï¼Œå¦‚ dataã€eventã€id ç­‰
        eventSource.value(); // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œè¿”å›å­—ç¬¦ä¸²ç±»å‹æ•°æ®
        // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œå¹¶å°†æ¶ˆæ¯è½¬æ¢ä¸ºæŒ‡å®šçš„è‡ªå®šä¹‰ç±»å‹
        eventSource.value(MyUser.class);
        // è·å–äº‹ä»¶æ¶ˆæ¯çš„å€¼ï¼Œå¹¶å°†æ¶ˆæ¯è½¬æ¢ä¸ºæŒ‡å®šçš„è‡ªå®šä¹‰æ³›å‹ç±»å‹
        eventSource.value(new TypeReference<List<MyUser>>() {});
    }
}
```

å…³äºå…·ä½“å¦‚ä½•å£°æ˜å’Œå®šä¹‰ SSE äº‹ä»¶æ¶ˆæ¯çš„å¤„ç†æ–¹æ³•ï¼Œè¯·å‚è§ã€Š[SSEäº‹ä»¶å¤„ç†æ–¹æ³•](/pages/1.7.x/sse_method/)ã€‹

## å…±äº«å˜é‡

å› ä¸ºæ¯ä¸ª SSE æ§åˆ¶å™¨ (åŒ…æ‹¬è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨) çš„å¯¹è±¡å¯¹äº SSE è¯·æ±‚æ¥è¯´éƒ½æ˜¯ä¸€å¯¹ä¸€ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥åœ¨ SSE æ§åˆ¶å™¨ä¸­å®šä¹‰çš„å˜é‡å±æ€§ä¹Ÿæ˜¯å¯¹å¤–éƒ¨ç‹¬ç«‹çš„

é‚£ä¹ˆåŸºäºè¿™ä¸€ç‚¹å°±å¯ä»¥ç”¨äºåœ¨åŒä¸€ä¸ª SSE äº‹ä»¶æµä¸­é€šè¿‡å…±äº«å˜é‡å®ç°è·¨äº‹ä»¶ã€è·¨ç”Ÿå‘½å‘¨æœŸçš„æ•°æ®ä¼ é€’ï¼Œè€Œä¸ç”¨æ‹…å¿ƒä¸åŒ SSE è¯·æ±‚ä¹‹é—´çš„æ•°æ®æ±¡æŸ“

```java
// è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ç±»ï¼Œéœ€è¦ç»§æ‰¿ ForestSSE
public class MySSEHandler extends ForestSSE {
    // å…±äº«å˜é‡
    private final StringBuffer buffer = new StringBuffer();

    @Override
    protected void onOpen(EventSource eventSource) {
        // SSE å¼€å§‹ç›‘å¬æ—¶è°ƒç”¨
        buffer.append("SSE Open").append("\n");
    }

    @Override
    protected void onClose(EventSource eventSource) {
        // SSE ç»“æŸç›‘å¬æ—¶è°ƒç”¨
        buffer.append("SSE Close");
    }

    @SSEMessage("data")
    public void onData(@SSEName String name, @SSEValue String value) {
        // å¤„ç†äº‹ä»¶æ¶ˆæ¯åç§°ä¸º data çš„äº‹ä»¶
        buffer.append("Receive ").append(name).append(": ").append(value).append("\n");
    }

    // è·å–å…±äº«å˜é‡ä¸­çš„å€¼
    public StringBuffer getStringBuffer() {
        return buffer;
    }
}

```

:::warning æ³¨æ„
ä¸èƒ½æ³¨å…¥ Spring ä¸Šä¸‹æ–‡

ä½†ä¹Ÿç”±äºä¸€å¯¹ä¸€ç‹¬ç«‹çš„ç‰¹æ€§ï¼ŒSSE æ§åˆ¶å™¨ä¸èƒ½æ³¨å…¥åˆ° Spring ä¸Šä¸‹æ–‡ä¸­

åŒæ—¶ä¹Ÿä¸èƒ½åœ¨è‡ªå®šä¹‰ SSE æ§åˆ¶å™¨ä¸­æ³¨å…¥ Spring ä¸Šä¸‹æ–‡ä¸­çš„å…¶ä»–å¯¹è±¡å’Œèµ„æº
:::


